diff --git a/.amplifier/settings.local.yaml b/.amplifier/settings.local.yaml
new file mode 100644
index 0000000..2f42b03
--- /dev/null
+++ b/.amplifier/settings.local.yaml
@@ -0,0 +1,7 @@
+config:
+  providers:
+  - config:
+      default_model: gemini-3-pro-preview
+      priority: 1
+    module: provider-gemini
+    source: /opt/amplifier-provider-gemini
diff --git a/package-lock.json b/package-lock.json
index b36b372..6f03430 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -19,12 +19,84 @@
         "@types/ws": "^8.5.0",
         "@typescript-eslint/eslint-plugin": "^7.0.0",
         "@typescript-eslint/parser": "^7.0.0",
+        "@vitest/coverage-v8": "^2.0.0",
         "eslint": "^8.56.0",
         "supertest": "^7.0.0",
         "typescript": "^5.4.0",
         "vitest": "^2.0.0"
       }
     },
+    "node_modules/@ampproject/remapping": {
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@ampproject/remapping/-/remapping-2.3.0.tgz",
+      "integrity": "sha512-30iZtAPgz+LTIYoeivqYo853f02jBYSd5uGnGpkFV0M3xOt9aN73erkgYAmZU43x4VfqcnLxW9Kpg3R5LC4YYw==",
+      "dev": true,
+      "license": "Apache-2.0",
+      "dependencies": {
+        "@jridgewell/gen-mapping": "^0.3.5",
+        "@jridgewell/trace-mapping": "^0.3.24"
+      },
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
+    "node_modules/@babel/helper-string-parser": {
+      "version": "7.27.1",
+      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
+      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6.9.0"
+      }
+    },
+    "node_modules/@babel/helper-validator-identifier": {
+      "version": "7.28.5",
+      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
+      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6.9.0"
+      }
+    },
+    "node_modules/@babel/parser": {
+      "version": "7.29.0",
+      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.29.0.tgz",
+      "integrity": "sha512-IyDgFV5GeDUVX4YdF/3CPULtVGSXXMLh1xVIgdCgxApktqnQV0r7/8Nqthg+8YLGaAtdyIlo2qIdZrbCv4+7ww==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@babel/types": "^7.29.0"
+      },
+      "bin": {
+        "parser": "bin/babel-parser.js"
+      },
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
+    "node_modules/@babel/types": {
+      "version": "7.29.0",
+      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.29.0.tgz",
+      "integrity": "sha512-LwdZHpScM4Qz8Xw2iKSzS+cfglZzJGvofQICy7W7v4caru4EaAmyUuO6BGrbyQ2mYV11W0U8j5mBhd14dd3B0A==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@babel/helper-string-parser": "^7.27.1",
+        "@babel/helper-validator-identifier": "^7.28.5"
+      },
+      "engines": {
+        "node": ">=6.9.0"
+      }
+    },
+    "node_modules/@bcoe/v8-coverage": {
+      "version": "0.2.3",
+      "resolved": "https://registry.npmjs.org/@bcoe/v8-coverage/-/v8-coverage-0.2.3.tgz",
+      "integrity": "sha512-0hYQ8SB4Db5zvZB4axdMHGwEaQjkZzFjQiN9LVYvIFB2nSUHW9tYpxWriPrWDASIxiaXax83REcLxuSdnGPZtw==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/@esbuild/aix-ppc64": {
       "version": "0.21.5",
       "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
@@ -565,6 +637,84 @@
       "dev": true,
       "license": "BSD-3-Clause"
     },
+    "node_modules/@isaacs/cliui": {
+      "version": "8.0.2",
+      "resolved": "https://registry.npmjs.org/@isaacs/cliui/-/cliui-8.0.2.tgz",
+      "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "string-width": "^5.1.2",
+        "string-width-cjs": "npm:string-width@^4.2.0",
+        "strip-ansi": "^7.0.1",
+        "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
+        "wrap-ansi": "^8.1.0",
+        "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
+      },
+      "engines": {
+        "node": ">=12"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/ansi-regex": {
+      "version": "6.2.2",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.2.tgz",
+      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/strip-ansi": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.2.tgz",
+      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
+    "node_modules/@istanbuljs/schema": {
+      "version": "0.1.3",
+      "resolved": "https://registry.npmjs.org/@istanbuljs/schema/-/schema-0.1.3.tgz",
+      "integrity": "sha512-ZXRY4jNvVgSVQ8DL3LTcakaAtXwTVUxE81hslsyD2AtoXW/wVob10HkOJ1X/pAlcI7D+2YoZKg5do8G/w6RYgA==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/@jridgewell/gen-mapping": {
+      "version": "0.3.13",
+      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
+      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@jridgewell/sourcemap-codec": "^1.5.0",
+        "@jridgewell/trace-mapping": "^0.3.24"
+      }
+    },
+    "node_modules/@jridgewell/resolve-uri": {
+      "version": "3.1.2",
+      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
+      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
     "node_modules/@jridgewell/sourcemap-codec": {
       "version": "1.5.5",
       "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
@@ -572,6 +722,17 @@
       "dev": true,
       "license": "MIT"
     },
+    "node_modules/@jridgewell/trace-mapping": {
+      "version": "0.3.31",
+      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
+      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@jridgewell/resolve-uri": "^3.1.0",
+        "@jridgewell/sourcemap-codec": "^1.4.14"
+      }
+    },
     "node_modules/@noble/hashes": {
       "version": "1.8.0",
       "resolved": "https://registry.npmjs.org/@noble/hashes/-/hashes-1.8.0.tgz",
@@ -633,6 +794,17 @@
         "@noble/hashes": "^1.1.5"
       }
     },
+    "node_modules/@pkgjs/parseargs": {
+      "version": "0.11.0",
+      "resolved": "https://registry.npmjs.org/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
+      "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
+      "dev": true,
+      "license": "MIT",
+      "optional": true,
+      "engines": {
+        "node": ">=14"
+      }
+    },
     "node_modules/@rollup/rollup-android-arm-eabi": {
       "version": "4.57.1",
       "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.57.1.tgz",
@@ -1081,7 +1253,6 @@
       "integrity": "sha512-m0jEgYlYz+mDJZ2+F4v8D1AyQb+QzsNqRuI7xg1VQX/KlKS0qT9r1Mo16yo5F/MtifXFgaofIFsdFMox2SxIbQ==",
       "dev": true,
       "license": "MIT",
-      "peer": true,
       "dependencies": {
         "undici-types": "~7.16.0"
       }
@@ -1207,7 +1378,6 @@
       "integrity": "sha512-4Z+L8I2OqhZV8qA132M4wNL30ypZGYOQVBfMgxDH/K5UX0PNqTu1c6za9ST5r9+tavvHiTWmBnKzpCJ/GlVFtg==",
       "dev": true,
       "license": "BSD-2-Clause",
-      "peer": true,
       "dependencies": {
         "@typescript-eslint/scope-manager": "7.18.0",
         "@typescript-eslint/types": "7.18.0",
@@ -1368,6 +1538,39 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/@vitest/coverage-v8": {
+      "version": "2.1.9",
+      "resolved": "https://registry.npmjs.org/@vitest/coverage-v8/-/coverage-v8-2.1.9.tgz",
+      "integrity": "sha512-Z2cOr0ksM00MpEfyVE8KXIYPEcBFxdbLSs56L8PO0QQMxt/6bDj45uQfxoc96v05KW3clk7vvgP0qfDit9DmfQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@ampproject/remapping": "^2.3.0",
+        "@bcoe/v8-coverage": "^0.2.3",
+        "debug": "^4.3.7",
+        "istanbul-lib-coverage": "^3.2.2",
+        "istanbul-lib-report": "^3.0.1",
+        "istanbul-lib-source-maps": "^5.0.6",
+        "istanbul-reports": "^3.1.7",
+        "magic-string": "^0.30.12",
+        "magicast": "^0.3.5",
+        "std-env": "^3.8.0",
+        "test-exclude": "^7.0.1",
+        "tinyrainbow": "^1.2.0"
+      },
+      "funding": {
+        "url": "https://opencollective.com/vitest"
+      },
+      "peerDependencies": {
+        "@vitest/browser": "2.1.9",
+        "vitest": "2.1.9"
+      },
+      "peerDependenciesMeta": {
+        "@vitest/browser": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/@vitest/expect": {
       "version": "2.1.9",
       "resolved": "https://registry.npmjs.org/@vitest/expect/-/expect-2.1.9.tgz",
@@ -1500,7 +1703,6 @@
       "integrity": "sha512-NZyJarBfL7nWwIq+FDL6Zp/yHEhePMNnnJ0y3qfieCrmNvYct8uvtiV41UvlSe6apAfk0fY1FbWx+NwfmpvtTg==",
       "dev": true,
       "license": "MIT",
-      "peer": true,
       "bin": {
         "acorn": "bin/acorn"
       },
@@ -2116,12 +2318,26 @@
         "node": ">= 0.4"
       }
     },
+    "node_modules/eastasianwidth": {
+      "version": "0.2.0",
+      "resolved": "https://registry.npmjs.org/eastasianwidth/-/eastasianwidth-0.2.0.tgz",
+      "integrity": "sha512-I88TYZWc9XiYHRQ4/3c5rjjfgkjhLyW2luGIheGERbNQ6OY7yTybanSpDXZa8y7VUP9YmDcYa+eyq4ca7iLqWA==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/ee-first": {
       "version": "1.1.1",
       "resolved": "https://registry.npmjs.org/ee-first/-/ee-first-1.1.1.tgz",
       "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==",
       "license": "MIT"
     },
+    "node_modules/emoji-regex": {
+      "version": "9.2.2",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-9.2.2.tgz",
+      "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/encodeurl": {
       "version": "2.0.0",
       "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
@@ -2258,7 +2474,6 @@
       "deprecated": "This version is no longer supported. Please see https://eslint.org/version-support for other options.",
       "dev": true,
       "license": "MIT",
-      "peer": true,
       "dependencies": {
         "@eslint-community/eslint-utils": "^4.2.0",
         "@eslint-community/regexpp": "^4.6.1",
@@ -2698,6 +2913,23 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/foreground-child": {
+      "version": "3.3.1",
+      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.3.1.tgz",
+      "integrity": "sha512-gIXjKqtFuWEgzFRJA9WCQeSJLZDjgJUOMCMzxtvFq/37KojM1BFGufqsCy0r4qSQmYLsZYMeyRqzIWOMup03sw==",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "cross-spawn": "^7.0.6",
+        "signal-exit": "^4.0.1"
+      },
+      "engines": {
+        "node": ">=14"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/form-data": {
       "version": "4.0.5",
       "resolved": "https://registry.npmjs.org/form-data/-/form-data-4.0.5.tgz",
@@ -2996,6 +3228,13 @@
         "node": ">= 0.4"
       }
     },
+    "node_modules/html-escaper": {
+      "version": "2.0.2",
+      "resolved": "https://registry.npmjs.org/html-escaper/-/html-escaper-2.0.2.tgz",
+      "integrity": "sha512-H2iMtd0I4Mt5eYiapRdIDjp+XzelXQ0tFE4JS7YFwFevXXMmOp9myNrUvCg0D6ws8iqkRPBfKHgbwig1SmlLfg==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/http-errors": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.1.tgz",
@@ -3128,6 +3367,16 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/is-glob": {
       "version": "4.0.3",
       "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
@@ -3168,6 +3417,76 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/istanbul-lib-coverage": {
+      "version": "3.2.2",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-coverage/-/istanbul-lib-coverage-3.2.2.tgz",
+      "integrity": "sha512-O8dpsF+r0WV/8MNRKfnmrtCWhuKjxrq2w+jpzBL5UZKTi2LeVWnWOmWRxFlesJONmc+wLAGvKQZEOanko0LFTg==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/istanbul-lib-report": {
+      "version": "3.0.1",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-report/-/istanbul-lib-report-3.0.1.tgz",
+      "integrity": "sha512-GCfE1mtsHGOELCU8e/Z7YWzpmybrx/+dSTfLrvY8qRmaY6zXTKWn6WQIjaAFw069icm6GVMNkgu0NzI4iPZUNw==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "dependencies": {
+        "istanbul-lib-coverage": "^3.0.0",
+        "make-dir": "^4.0.0",
+        "supports-color": "^7.1.0"
+      },
+      "engines": {
+        "node": ">=10"
+      }
+    },
+    "node_modules/istanbul-lib-source-maps": {
+      "version": "5.0.6",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-source-maps/-/istanbul-lib-source-maps-5.0.6.tgz",
+      "integrity": "sha512-yg2d+Em4KizZC5niWhQaIomgf5WlL4vOOjZ5xGCmF8SnPE/mDWWXgvRExdcpCgh9lLRRa1/fSYp2ymmbJ1pI+A==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "dependencies": {
+        "@jridgewell/trace-mapping": "^0.3.23",
+        "debug": "^4.1.1",
+        "istanbul-lib-coverage": "^3.0.0"
+      },
+      "engines": {
+        "node": ">=10"
+      }
+    },
+    "node_modules/istanbul-reports": {
+      "version": "3.2.0",
+      "resolved": "https://registry.npmjs.org/istanbul-reports/-/istanbul-reports-3.2.0.tgz",
+      "integrity": "sha512-HGYWWS/ehqTV3xN10i23tkPkpH46MLCIMFNCaaKNavAXTF1RkqxawEPtnjnGZ6XKSInBKkiOA5BKS+aZiY3AvA==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "dependencies": {
+        "html-escaper": "^2.0.0",
+        "istanbul-lib-report": "^3.0.0"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/jackspeak": {
+      "version": "3.4.3",
+      "resolved": "https://registry.npmjs.org/jackspeak/-/jackspeak-3.4.3.tgz",
+      "integrity": "sha512-OGlZQpz2yfahA/Rd1Y8Cd9SIEsqvXkLVoSw/cgwhnhFMDbsQFeZYoJJ7bIZBS9BcamUW96asq/npPWugM+RQBw==",
+      "dev": true,
+      "license": "BlueOak-1.0.0",
+      "dependencies": {
+        "@isaacs/cliui": "^8.0.2"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      },
+      "optionalDependencies": {
+        "@pkgjs/parseargs": "^0.11.0"
+      }
+    },
     "node_modules/js-yaml": {
       "version": "4.1.1",
       "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.1.tgz",
@@ -3256,6 +3575,13 @@
       "dev": true,
       "license": "MIT"
     },
+    "node_modules/lru-cache": {
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true,
+      "license": "ISC"
+    },
     "node_modules/magic-string": {
       "version": "0.30.21",
       "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.21.tgz",
@@ -3266,6 +3592,34 @@
         "@jridgewell/sourcemap-codec": "^1.5.5"
       }
     },
+    "node_modules/magicast": {
+      "version": "0.3.5",
+      "resolved": "https://registry.npmjs.org/magicast/-/magicast-0.3.5.tgz",
+      "integrity": "sha512-L0WhttDl+2BOsybvEOLK7fW3UA0OQ0IQ2d6Zl2x/a6vVRs3bAY0ECOSHHeL5jD+SbOpOCUEi0y1DgHEn9Qn1AQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@babel/parser": "^7.25.4",
+        "@babel/types": "^7.25.4",
+        "source-map-js": "^1.2.0"
+      }
+    },
+    "node_modules/make-dir": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/make-dir/-/make-dir-4.0.0.tgz",
+      "integrity": "sha512-hXdUTZYIVOt1Ex//jAQi+wTZZpUpwBj/0QsOzqegb3rGMMeJiSEu5xLHnYfBrRV4RH2+OCSOO95Is/7x1WJ4bw==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "semver": "^7.5.3"
+      },
+      "engines": {
+        "node": ">=10"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/math-intrinsics": {
       "version": "1.1.0",
       "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
@@ -3396,6 +3750,16 @@
         "url": "https://github.com/sponsors/ljharb"
       }
     },
+    "node_modules/minipass": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.1.2.tgz",
+      "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
+      "dev": true,
+      "license": "ISC",
+      "engines": {
+        "node": ">=16 || 14 >=14.17"
+      }
+    },
     "node_modules/mkdirp-classic": {
       "version": "0.5.3",
       "resolved": "https://registry.npmjs.org/mkdirp-classic/-/mkdirp-classic-0.5.3.tgz",
@@ -3544,6 +3908,13 @@
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
+    "node_modules/package-json-from-dist": {
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/package-json-from-dist/-/package-json-from-dist-1.0.1.tgz",
+      "integrity": "sha512-UEZIS3/by4OC8vL3P2dTXRETpebLI2NiI5vIrjaD/5UtrkFX/tNbwjTSRAGC/+7CAo2pIcBaRgWmcBBHcsaCIw==",
+      "dev": true,
+      "license": "BlueOak-1.0.0"
+    },
     "node_modules/parent-module": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
@@ -3596,6 +3967,23 @@
         "node": ">=8"
       }
     },
+    "node_modules/path-scurry": {
+      "version": "1.11.1",
+      "resolved": "https://registry.npmjs.org/path-scurry/-/path-scurry-1.11.1.tgz",
+      "integrity": "sha512-Xa4Nw17FS9ApQFJ9umLiJS4orGjm7ZzwUrwamcGQuHSzDyth9boKDaycYdDcZDuqYATXw4HFXgaqWTctW/v1HA==",
+      "dev": true,
+      "license": "BlueOak-1.0.0",
+      "dependencies": {
+        "lru-cache": "^10.2.0",
+        "minipass": "^5.0.0 || ^6.0.2 || ^7.0.0"
+      },
+      "engines": {
+        "node": ">=16 || 14 >=14.18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/path-to-regexp": {
       "version": "0.1.12",
       "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
@@ -4152,6 +4540,19 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/signal-exit": {
+      "version": "4.1.0",
+      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
+      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
+      "dev": true,
+      "license": "ISC",
+      "engines": {
+        "node": ">=14"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/simple-concat": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/simple-concat/-/simple-concat-1.0.1.tgz",
@@ -4249,6 +4650,76 @@
         "safe-buffer": "~5.2.0"
       }
     },
+    "node_modules/string-width": {
+      "version": "5.1.2",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-5.1.2.tgz",
+      "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "eastasianwidth": "^0.2.0",
+        "emoji-regex": "^9.2.2",
+        "strip-ansi": "^7.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/string-width-cjs": {
+      "name": "string-width",
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/string-width-cjs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/string-width/node_modules/ansi-regex": {
+      "version": "6.2.2",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.2.tgz",
+      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/string-width/node_modules/strip-ansi": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.2.tgz",
+      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
     "node_modules/strip-ansi": {
       "version": "6.0.1",
       "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
@@ -4262,6 +4733,20 @@
         "node": ">=8"
       }
     },
+    "node_modules/strip-ansi-cjs": {
+      "name": "strip-ansi",
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
+      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^5.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/strip-json-comments": {
       "version": "3.1.1",
       "resolved": "https://registry.npmjs.org/strip-json-comments/-/strip-json-comments-3.1.1.tgz",
@@ -4375,6 +4860,43 @@
         "node": ">=6"
       }
     },
+    "node_modules/test-exclude": {
+      "version": "7.0.1",
+      "resolved": "https://registry.npmjs.org/test-exclude/-/test-exclude-7.0.1.tgz",
+      "integrity": "sha512-pFYqmTw68LXVjeWJMST4+borgQP2AyMNbg1BpZh9LbyhUeNkeaPF9gzfPGUAnSMV3qPYdWUwDIjjCLiSDOl7vg==",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "@istanbuljs/schema": "^0.1.2",
+        "glob": "^10.4.1",
+        "minimatch": "^9.0.4"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/test-exclude/node_modules/glob": {
+      "version": "10.5.0",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.5.0.tgz",
+      "integrity": "sha512-DfXN8DfhJ7NH3Oe7cFmu3NCu1wKbkReJ8TorzSAFbSKrlNaQSKfIzqYqVY8zlbs2NLBbWpRiU52GX2PbaBVNkg==",
+      "deprecated": "Old versions of glob are not supported, and contain widely publicized security vulnerabilities, which have been fixed in the current version. Please update. Support for old versions may be purchased (at exorbitant rates) by contacting i@izs.me",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "foreground-child": "^3.1.0",
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
+      },
+      "bin": {
+        "glob": "dist/esm/bin.mjs"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/text-table": {
       "version": "0.2.0",
       "resolved": "https://registry.npmjs.org/text-table/-/text-table-0.2.0.tgz",
@@ -4518,7 +5040,6 @@
       "integrity": "sha512-jl1vZzPDinLr9eUt3J/t7V6FgNEw9QjvBPdysz9KfQDD41fQrC2Y4vKQdiaUpFT4bXlb1RHhLpp8wtm6M5TgSw==",
       "dev": true,
       "license": "Apache-2.0",
-      "peer": true,
       "bin": {
         "tsc": "bin/tsc",
         "tsserver": "bin/tsserver"
@@ -4769,6 +5290,107 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/wrap-ansi": {
+      "version": "8.1.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
+      "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-styles": "^6.1.0",
+        "string-width": "^5.0.1",
+        "strip-ansi": "^7.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi-cjs": {
+      "name": "wrap-ansi",
+      "version": "7.0.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
+      "integrity": "sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-styles": "^4.0.0",
+        "string-width": "^4.1.0",
+        "strip-ansi": "^6.0.0"
+      },
+      "engines": {
+        "node": ">=10"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi-cjs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/wrap-ansi-cjs/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/ansi-regex": {
+      "version": "6.2.2",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.2.tgz",
+      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/ansi-styles": {
+      "version": "6.2.3",
+      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.3.tgz",
+      "integrity": "sha512-4Dj6M28JB+oAH8kFkTLUo+a2jwOFkuqb3yucU0CANcRRUbxS0cP0nZYCGjcc3BNXwRIsUVmDGgzawme7zvJHvg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/strip-ansi": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.2.tgz",
+      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
     "node_modules/wrappy": {
       "version": "1.0.2",
       "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
diff --git a/schema.sql b/schema.sql
deleted file mode 100644
index 3f23605..0000000
--- a/schema.sql
+++ /dev/null
@@ -1,23 +0,0 @@
-CREATE TABLE IF NOT EXISTS documents (
-  id TEXT PRIMARY KEY,
-  title TEXT NOT NULL,
-  content TEXT NOT NULL DEFAULT '',
-  created_at TEXT NOT NULL DEFAULT (datetime('now')),
-  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
-);
-
-CREATE TABLE IF NOT EXISTS versions (
-  id INTEGER PRIMARY KEY AUTOINCREMENT,
-  document_id TEXT NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
-  version INTEGER NOT NULL,
-  content TEXT NOT NULL,
-  operation TEXT, -- JSON of the operation that produced this version
-  created_at TEXT NOT NULL DEFAULT (datetime('now')),
-  UNIQUE(document_id, version)
-);
-
-CREATE TABLE IF NOT EXISTS active_connections (
-  id TEXT PRIMARY KEY,
-  document_id TEXT NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
-  connected_at TEXT NOT NULL DEFAULT (datetime('now'))
-);
diff --git a/src/db.ts b/src/db.ts
new file mode 100644
index 0000000..9ee32dd
--- /dev/null
+++ b/src/db.ts
@@ -0,0 +1,85 @@
+import Database from 'better-sqlite3';
+import { Document, DocumentVersion } from './types.js';
+
+export class DB {
+  private db: Database.Database;
+
+  constructor(filename: string = ':memory:') {
+    this.db = new Database(filename);
+    this.init();
+  }
+
+  private init() {
+    const schema = `
+    CREATE TABLE IF NOT EXISTS documents (
+      id TEXT PRIMARY KEY,
+      title TEXT NOT NULL,
+      content TEXT NOT NULL DEFAULT '',
+      created_at TEXT NOT NULL DEFAULT (datetime('now')),
+      updated_at TEXT NOT NULL DEFAULT (datetime('now'))
+    );
+
+    CREATE TABLE IF NOT EXISTS versions (
+      id INTEGER PRIMARY KEY AUTOINCREMENT,
+      document_id TEXT NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
+      version INTEGER NOT NULL,
+      content TEXT NOT NULL,
+      operation TEXT,
+      created_at TEXT NOT NULL DEFAULT (datetime('now')),
+      UNIQUE(document_id, version)
+    );
+    `;
+    this.db.exec(schema);
+  }
+
+  createDocument(id: string, title: string): Document {
+    const stmt = this.db.prepare('INSERT INTO documents (id, title, content) VALUES (?, ?, ?)');
+    stmt.run(id, title, '');
+    return this.getDocument(id)!;
+  }
+
+  getDocument(id: string): Document | undefined {
+    const stmt = this.db.prepare('SELECT * FROM documents WHERE id = ?');
+    return stmt.get(id) as Document | undefined;
+  }
+
+  listDocuments(): Document[] {
+    const stmt = this.db.prepare('SELECT * FROM documents');
+    return stmt.all() as Document[];
+  }
+
+  updateDocumentContent(id: string, content: string) {
+    const stmt = this.db.prepare('UPDATE documents SET content = ?, updated_at = datetime(\'now\') WHERE id = ?');
+    stmt.run(content, id);
+  }
+
+  updateDocumentTitle(id: string, title: string) {
+    const stmt = this.db.prepare('UPDATE documents SET title = ?, updated_at = datetime(\'now\') WHERE id = ?');
+    stmt.run(title, id);
+  }
+
+  addVersion(documentId: string, version: number, content: string, operation: string) {
+    const stmt = this.db.prepare('INSERT INTO versions (document_id, version, content, operation) VALUES (?, ?, ?, ?)');
+    stmt.run(documentId, version, content, operation);
+  }
+
+  getVersions(documentId: string): DocumentVersion[] {
+    const stmt = this.db.prepare('SELECT * FROM versions WHERE document_id = ? ORDER BY version ASC');
+    return stmt.all(documentId) as DocumentVersion[];
+  }
+  
+  getLatestVersion(documentId: string): number {
+      const stmt = this.db.prepare('SELECT MAX(version) as max_ver FROM versions WHERE document_id = ?');
+      const res = stmt.get(documentId) as { max_ver: number | null };
+      return res.max_ver || 0;
+  }
+
+  deleteDocument(id: string) {
+    const stmt = this.db.prepare('DELETE FROM documents WHERE id = ?');
+    stmt.run(id);
+  }
+
+  close() {
+    this.db.close();
+  }
+}
diff --git a/src/ot.ts b/src/ot.ts
new file mode 100644
index 0000000..1fd1764
--- /dev/null
+++ b/src/ot.ts
@@ -0,0 +1,97 @@
+import { Operation } from './types.js';
+
+export function applyOperation(content: string, op: Operation): string {
+  if (op.type === 'insert') {
+    return content.slice(0, op.position) + op.text + content.slice(op.position);
+  } else if (op.type === 'delete') {
+    return content.slice(0, op.position) + content.slice(op.position + op.length);
+  }
+  return content;
+}
+
+/**
+ * Transforms op1 against op2, assuming op2 has already been applied.
+ * Returns an array of operations that represent op1 in the new context.
+ */
+export function transform(op: Operation, against: Operation): Operation[] {
+  if (op.type === 'insert' && against.type === 'insert') {
+    if (op.position < against.position) {
+      return [op];
+    } else if (op.position > against.position) {
+      return [{ ...op, position: op.position + against.text.length }];
+    } else {
+      // Tie-breaker: incoming op (op) is considered "later" or "wins" position, 
+      // so it shifts after the existing one (against).
+      return [{ ...op, position: op.position + against.text.length }];
+    }
+  }
+
+  if (op.type === 'insert' && against.type === 'delete') {
+    if (op.position <= against.position) {
+      return [op];
+    } else if (op.position >= against.position + against.length) {
+      return [{ ...op, position: op.position - against.length }];
+    } else {
+      // Insert falls within the deleted range.
+      // The range is gone, so the position collapses to the start of the delete.
+      return [{ ...op, position: against.position }];
+    }
+  }
+
+  if (op.type === 'delete' && against.type === 'insert') {
+    if (op.position + op.length <= against.position) {
+      return [op];
+    } else if (op.position >= against.position) {
+      return [{ ...op, position: op.position + against.text.length }];
+    } else {
+      // Delete overlaps insert.
+      // Split into two deletes: one before the insert, one after.
+      
+      const firstPartLen = against.position - op.position;
+      const remainingLen = op.length - firstPartLen;
+      
+      const ops: Operation[] = [];
+      if (firstPartLen > 0) {
+        ops.push({ type: 'delete', position: op.position, length: firstPartLen });
+      }
+      if (remainingLen > 0) {
+        // The second part starts AFTER the inserted text.
+        ops.push({ type: 'delete', position: against.position + against.text.length, length: remainingLen });
+      }
+      return ops;
+    }
+  }
+
+  if (op.type === 'delete' && against.type === 'delete') {
+    const opStart = op.position;
+    const opEnd = op.position + op.length;
+    const agStart = against.position;
+    const agEnd = against.position + against.length;
+
+    if (opEnd <= agStart) {
+      return [op];
+    } else if (opStart >= agEnd) {
+      return [{ ...op, position: opStart - against.length }];
+    } else {
+      // Overlap
+      const ops: Operation[] = [];
+      
+      // Part before 'against'
+      if (opStart < agStart) {
+        const len = agStart - opStart;
+        ops.push({ type: 'delete', position: opStart, length: len });
+      }
+      
+      // Part after 'against'
+      if (opEnd > agEnd) {
+        const len = opEnd - agEnd;
+        // In the new document, agEnd maps to agStart.
+        ops.push({ type: 'delete', position: agStart, length: len });
+      }
+      
+      return ops;
+    }
+  }
+
+  return [op];
+}
diff --git a/src/server.ts b/src/server.ts
new file mode 100644
index 0000000..f407bbc
--- /dev/null
+++ b/src/server.ts
@@ -0,0 +1,231 @@
+import express from 'express';
+import { WebSocketServer, WebSocket } from 'ws';
+import http from 'http';
+import { DB } from './db.js';
+import { applyOperation, transform } from './ot.js';
+import { ClientMessage, ServerMessage, Operation } from './types.js';
+
+export function createApp(dbPath?: string) {
+  const app = express();
+  app.use(express.json());
+
+  const db = new DB(dbPath);
+  const server = http.createServer(app);
+  const wss = new WebSocketServer({ server });
+
+  // REST API
+  app.post('/documents', (req, res) => {
+    const { id, title } = req.body;
+    if (!id || !title) {
+      return res.status(400).json({ error: 'Missing id or title' });
+    }
+    try {
+      const doc = db.createDocument(id, title);
+      res.status(201).json(doc);
+    } catch (err) {
+      const error = err as { code?: string; message: string };
+      if (error.code === 'SQLITE_CONSTRAINT_PRIMARYKEY') {
+        res.status(409).json({ error: 'Document already exists' });
+      } else {
+        res.status(500).json({ error: error.message });
+      }
+    }
+  });
+
+  app.get('/documents', (req, res) => {
+    const docs = db.listDocuments();
+    res.json(docs);
+  });
+
+  app.get('/documents/:id', (req, res) => {
+    const doc = db.getDocument(req.params.id);
+    if (!doc) {
+      return res.status(404).json({ error: 'Document not found' });
+    }
+    res.json(doc);
+  });
+
+  app.put('/documents/:id', (req, res) => {
+    const { title } = req.body;
+    if (!title) {
+      return res.status(400).json({ error: 'Missing title' });
+    }
+    const doc = db.getDocument(req.params.id);
+    if (!doc) {
+      return res.status(404).json({ error: 'Document not found' });
+    }
+    db.updateDocumentTitle(req.params.id, title);
+    res.json({ ...doc, title });
+  });
+
+  app.delete('/documents/:id', (req, res) => {
+    try {
+      const doc = db.getDocument(req.params.id);
+      if (!doc) {
+        return res.status(404).json({ error: 'Document not found' });
+      }
+      db.deleteDocument(req.params.id);
+      res.status(204).send();
+    } catch (e) {
+      res.status(500).json({ error: 'Internal error' });
+    }
+  });
+  
+  // Map of document ID to Set of WebSockets
+  const docClients = new Map<string, Set<WebSocket>>();
+
+  wss.on('connection', (ws, req) => {
+    const url = new URL(req.url || '', `http://${req.headers.host}`);
+    // Extract document ID from path, e.g. /doc/:id
+    const match = url.pathname.match(/^\/doc\/(.+)$/);
+    if (!match) {
+      ws.close(1008, 'Invalid path');
+      return;
+    }
+    const docId = match[1];
+
+    const doc = db.getDocument(docId);
+    if (!doc) {
+      ws.close(1008, 'Document not found');
+      return;
+    }
+
+    if (!docClients.has(docId)) {
+      docClients.set(docId, new Set());
+    }
+    docClients.get(docId)!.add(ws);
+
+    // Send initial sync
+    const latestVer = db.getLatestVersion(docId);
+    const syncMsg: ServerMessage = {
+      type: 'sync',
+      documentId: docId,
+      version: latestVer,
+      content: doc.content
+    };
+    ws.send(JSON.stringify(syncMsg));
+
+    ws.on('message', (data) => {
+      try {
+        const msg = JSON.parse(data.toString()) as ClientMessage;
+        
+        if (msg.type === 'op') {
+          if (!msg.op || typeof msg.version !== 'number') {
+            ws.send(JSON.stringify({ type: 'error', message: 'Invalid op or version' }));
+            return;
+          }
+
+          // Concurrency control
+          // 1. Get all ops from msg.version to current latest
+          const history = db.getVersions(docId);
+          
+          const concurrentOps = history
+            .filter(v => v.version > msg.version!)
+            .map(v => JSON.parse(v.operation) as Operation);
+
+          // 2. Transform incoming op against concurrent ops
+          let transformedOps: Operation[] = [msg.op];
+          
+          for (const pastOp of concurrentOps) {
+            const newTransformedOps: Operation[] = [];
+            for (const currentOp of transformedOps) {
+               const res = transform(currentOp, pastOp);
+               newTransformedOps.push(...res);
+            }
+            transformedOps = newTransformedOps;
+          }
+
+          // 3. Apply transformed ops to current content
+          // We need to fetch the *latest* content again to be safe, or track it in memory.
+          // Since we are single-threaded (Node), we can trust db.getDocument(docId).content 
+          // IS the state after all committed versions.
+          const currentDoc = db.getDocument(docId)!;
+          let newContent = currentDoc.content;
+          
+          for (const op of transformedOps) {
+             newContent = applyOperation(newContent, op);
+          }
+
+          // 4. Save new version(s)
+          // If transformedOps has multiple operations (due to splits), apply them sequentially as distinct versions.
+          // This keeps the schema simple (one op per version) and ensures all insertions are preserved.
+          
+          let nextVer = db.getLatestVersion(docId) + 1;
+          let tempContent = currentDoc.content;
+          
+          for (const op of transformedOps) {
+             const opResult = applyOperation(tempContent, op);
+             tempContent = opResult;
+             
+             db.updateDocumentContent(docId, tempContent);
+             db.addVersion(docId, nextVer, tempContent, JSON.stringify(op));
+             
+             // Broadcast this op
+             const broadcastMsg: ServerMessage = {
+               type: 'op',
+               documentId: docId,
+               version: nextVer,
+               op: op
+             };
+             
+             const clients = docClients.get(docId);
+             if (clients) {
+               for (const client of clients) {
+                 if (client !== ws && client.readyState === WebSocket.OPEN) {
+                   client.send(JSON.stringify(broadcastMsg));
+                 }
+               }
+             }
+             
+             nextVer++;
+          }
+          
+          // Ack to sender
+          // We send back the *last* version we committed.
+          // The client will see that we processed their op.
+          
+          ws.send(JSON.stringify({
+            type: 'ack',
+            documentId: docId,
+            version: nextVer - 1
+          }));
+
+        }
+      } catch (e) {
+        console.error('Error processing message', e);
+        ws.send(JSON.stringify({ type: 'error', message: 'Internal server error' }));
+      }
+    });
+
+    ws.on('close', () => {
+      const clients = docClients.get(docId);
+      if (clients) {
+        clients.delete(ws);
+        if (clients.size === 0) {
+          docClients.delete(docId);
+        }
+      }
+    });
+  });
+
+  return {
+    app,
+    start: (port: number = 0) => {
+      return new Promise<number>((resolve) => {
+        server.listen(port, () => {
+          const address = server.address();
+          if (typeof address === 'object' && address) {
+            resolve(address.port);
+          } else {
+            resolve(port);
+          }
+        });
+      });
+    },
+    stop: () => {
+      wss.close();
+      server.close();
+      db.close();
+    }
+  };
+}
diff --git a/src/types.ts b/src/types.ts
new file mode 100644
index 0000000..1037b9f
--- /dev/null
+++ b/src/types.ts
@@ -0,0 +1,36 @@
+export interface Document {
+  id: string;
+  title: string;
+  content: string;
+  created_at: string;
+  updated_at: string;
+}
+
+export interface DocumentVersion {
+  id: number;
+  document_id: string;
+  version: number;
+  content: string; // Content AFTER this version's operation
+  operation: string; // JSON string of the operation
+  created_at: string;
+}
+
+export type Operation = 
+  | { type: 'insert'; position: number; text: string }
+  | { type: 'delete'; position: number; length: number };
+
+export interface ClientMessage {
+  type: 'join' | 'op';
+  documentId: string;
+  version?: number; // The version the client *thinks* it is on
+  op?: Operation;
+}
+
+export interface ServerMessage {
+  type: 'sync' | 'op' | 'ack' | 'error';
+  documentId: string;
+  version?: number;
+  content?: string;
+  op?: Operation;
+  message?: string;
+}
diff --git a/test/server.test.ts b/test/server.test.ts
new file mode 100644
index 0000000..cb6b2ab
--- /dev/null
+++ b/test/server.test.ts
@@ -0,0 +1,178 @@
+import { describe, it, expect, beforeAll, afterAll, beforeEach } from 'vitest';
+import { createApp } from '../src/server.js';
+import request from 'supertest';
+import WebSocket from 'ws';
+import { ClientMessage, ServerMessage, Operation } from '../src/types.js';
+
+describe('Collaborative Editor', () => {
+  let app: any;
+  let start: (port?: number) => Promise<number>;
+  let stop: () => void;
+  let port: number;
+  let serverUrl: string;
+  let wsUrl: string;
+
+  beforeAll(async () => {
+    const server = createApp(':memory:');
+    app = server.app;
+    start = server.start;
+    stop = server.stop;
+    port = await start(0);
+    serverUrl = `http://localhost:${port}`;
+    wsUrl = `ws://localhost:${port}`;
+  });
+
+  afterAll(() => {
+    stop();
+  });
+
+  it('should create a document via REST', async () => {
+    const res = await request(app)
+      .post('/documents')
+      .send({ id: 'doc1', title: 'My Doc' });
+    
+    expect(res.status).toBe(201);
+    expect(res.body).toMatchObject({
+      id: 'doc1',
+      title: 'My Doc',
+      content: ''
+    });
+  });
+
+  it('should list documents', async () => {
+    const res = await request(app).get('/documents');
+    expect(res.status).toBe(200);
+    expect(res.body).toHaveLength(1);
+    expect(res.body[0].id).toBe('doc1');
+  });
+
+  it('should support WebSocket connection and initial sync', async () => {
+    return new Promise<void>((resolve, reject) => {
+      const ws = new WebSocket(`${wsUrl}/doc/doc1`);
+      
+      ws.on('open', () => {
+        // Connected
+      });
+
+      ws.on('message', (data) => {
+        const msg = JSON.parse(data.toString()) as ServerMessage;
+        if (msg.type === 'sync') {
+          expect(msg.documentId).toBe('doc1');
+          expect(msg.content).toBe('');
+          expect(msg.version).toBe(0);
+          ws.close();
+          resolve();
+        }
+      });
+      
+      ws.on('error', reject);
+    });
+  });
+
+  it('should handle simple edits', async () => {
+    // Client A connects
+    const ws = new WebSocket(`${wsUrl}/doc/doc1`);
+    
+    const openPromise = new Promise<void>(resolve => ws.on('open', resolve));
+    const syncPromise = new Promise<void>(resolve => ws.once('message', resolve));
+    
+    await openPromise;
+    await syncPromise;
+    
+    // Send op: insert "Hello" at 0
+    const op: Operation = { type: 'insert', position: 0, text: 'Hello' };
+    ws.send(JSON.stringify({
+      type: 'op',
+      documentId: 'doc1',
+      version: 0,
+      op
+    }));
+    
+    // Expect Ack
+    const msg = await new Promise<ServerMessage>(resolve => {
+        ws.once('message', (data) => resolve(JSON.parse(data.toString())));
+    });
+    
+    expect(msg.type).toBe('ack');
+    expect(msg.version).toBe(1);
+    
+    ws.close();
+    
+    // Verify content via REST
+    const res = await request(app).get('/documents/doc1');
+    expect(res.body.content).toBe('Hello');
+  });
+
+  it('should handle concurrent edits (OT)', async () => {
+    await request(app).post('/documents').send({ id: 'doc2', title: 'Concurrent Doc' });
+    
+    const wsA = new WebSocket(`${wsUrl}/doc/doc2`);
+    const wsB = new WebSocket(`${wsUrl}/doc/doc2`);
+    
+    const openA = new Promise<void>(r => wsA.on('open', r));
+    const openB = new Promise<void>(r => wsB.on('open', r));
+    const syncA = new Promise<void>(r => wsA.once('message', r));
+    const syncB = new Promise<void>(r => wsB.once('message', r));
+    
+    await Promise.all([openA, openB, syncA, syncB]);
+    
+    // Both start at version 0.
+    // A inserts "A" at 0.
+    // B inserts "B" at 0.
+    
+    wsA.send(JSON.stringify({
+        type: 'op',
+        documentId: 'doc2',
+        version: 0,
+        op: { type: 'insert', position: 0, text: 'A' }
+    }));
+    
+    wsB.send(JSON.stringify({
+        type: 'op',
+        documentId: 'doc2',
+        version: 0,
+        op: { type: 'insert', position: 0, text: 'B' }
+    }));
+    
+    // Wait for all messages to settle.
+    // We expect 2 messages for each client (Ack + Broadcast)
+    // Actually:
+    // Client A sends op. Gets Ack. Gets Broadcast (from B).
+    // Client B sends op. Gets Ack. Gets Broadcast (from A).
+    // The order depends on server processing order.
+    
+    // Let's just wait a bit for server to process.
+    await new Promise(r => setTimeout(r, 500));
+    
+    wsA.close();
+    wsB.close();
+    
+    const res = await request(app).get('/documents/doc2');
+    // It should be "AB" or "BA", but definitely length 2 and containing both.
+    expect(['AB', 'BA']).toContain(res.body.content);
+  });
+
+  it('should update document title', async () => {
+    await request(app).post('/documents').send({ id: 'doc3', title: 'Old Title' });
+    
+    const res = await request(app)
+      .put('/documents/doc3')
+      .send({ title: 'New Title' });
+      
+    expect(res.status).toBe(200);
+    expect(res.body.title).toBe('New Title');
+    
+    const check = await request(app).get('/documents/doc3');
+    expect(check.body.title).toBe('New Title');
+  });
+
+  it('should delete a document', async () => {
+    await request(app).post('/documents').send({ id: 'doc4', title: 'To Delete' });
+    
+    const res = await request(app).delete('/documents/doc4');
+    expect(res.status).toBe(204);
+    
+    const check = await request(app).get('/documents/doc4');
+    expect(check.status).toBe(404);
+  });
+});
