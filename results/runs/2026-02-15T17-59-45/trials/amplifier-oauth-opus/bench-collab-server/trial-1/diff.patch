diff --git a/.amplifier-stdout.log b/.amplifier-stdout.log
new file mode 100644
index 0000000..d6d3f54
--- /dev/null
+++ b/.amplifier-stdout.log
@@ -0,0 +1,1449 @@
+Preparing bundle 'foundation'...
+Bundle 'foundation' prepared successfully
+
+Session ID: 016028c6-210f-49a9-aa4c-9e7ff39a795c
+Bundle: foundation | Provider: Anthropic | claude-opus-4-6
+
+[90m============================================================[0m
+[90mThinking:[0m
+[90m------------------------------------------------------------[0m
+[2mThe user wants me to build a collaborative real-time        
+document editing server. Let me break this down and plan the
+implementation carefully.                                   
+
+Let me first explore the existing project structure to      
+understand what's already set up.[0m
+[90m============================================================[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 37,455 (caching...) | Output: 400 | Total: 37,855[0m
+
+[36müîß Using tool: todo[0m
+   [2maction: create[0m
+   [2mtodos:[0m
+   [2m- content: Explore existing project structure and configuration[0m
+   [2m  status: in_progress[0m
+   [2m  activeForm: Exploring existing project structure[0m
+   [2m... (24 more lines)[0m
+[36m‚úÖ Tool result: todo[0m
+[2m   status: created
+   count: 9
+   todos:
+   - content: Explore existing project structure and configuration
+     status: in_progress
+   ... (25 more lines)[0m
+
+
+[2;37m‚îå‚îÄ Todo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [1;36m‚ñ∂[0m [1;36mExploring existing project structure[0m                     [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mDesign architecture for collaborative document editor[0m    [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mImplement database layer (SQLite schema, queries)[0m        [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mImplement OT engine for conflict resolution[0m              [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mImplement REST API for document management[0m               [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mImplement WebSocket collaboration layer[0m                  [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mImplement server factory (createApp)[0m                     [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mBuild and lint[0m                                           [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mWrite tests and verify functionality[0m                     [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [32m[0m[2;37m‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë[0m 0/9                               [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò[0m
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 38,242 (94% cached) | Output: 144 | Total: 38,386[0m
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace
+   content: |
+       Directory: /workspace
+       
+         DIR  .amplifier
+   ... (15 more lines)[0m
+
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/package.json[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/package.json
+   content: |
+            1	{
+            2	  "name": "bench-collab-server",
+            3	  "version": "1.0.0",
+   ... (29 more lines)[0m
+
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/tsconfig.json[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/tsconfig.json
+   content: |
+            1	{
+            2	  "compilerOptions": {
+            3	    "target": "ES2022",
+   ... (19 more lines)[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 39,508 (91% cached) | Output: 194 | Total: 39,702[0m
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/schema.sql[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/schema.sql
+   content: |
+            1	CREATE TABLE IF NOT EXISTS documents (
+            2	  id TEXT PRIMARY KEY,
+            3	  title TEXT NOT NULL,
+   ... (23 more lines)[0m
+
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/src[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/src
+   content: |
+       Directory: /workspace/src
+       
+         FILE .gitkeep
+   ... (2 more lines)[0m
+
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/.eslintrc.cjs[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/.eslintrc.cjs
+   content: |
+            1	module.exports = {
+            2	  parser: '@typescript-eslint/parser',
+            3	  plugins: ['@typescript-eslint'],
+   ... (16 more lines)[0m
+
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/vitest.config.ts[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/vitest.config.ts
+   content: |
+            1	import { defineConfig } from 'vitest/config';
+            2	
+            3	export default defineConfig({
+   ... (8 more lines)[0m
+
+
+[90m============================================================[0m
+[90mThinking:[0m
+[90m------------------------------------------------------------[0m
+[2mNow I have a clear picture of the project structure. Let me 
+design and implement the collaborative document editor. The 
+project has:                                                
+
+ ‚Ä¢ TypeScript with ES modules (Node16)                      
+ ‚Ä¢ Express, ws, better-sqlite3 as dependencies              
+ ‚Ä¢ A schema.sql with documents, versions, and               
+   active_connections tables                                
+ ‚Ä¢ Empty src/ directory                                     
+ ‚Ä¢ vitest for testing                                       
+
+Let me plan the architecture:                               
+
+ 1 Database layer (src/database.ts) - SQLite operations     
+   using better-sqlite3                                     
+ 2 OT Engine (src/ot.ts) - Operational Transform for        
+   conflict resolution                                      
+ 3 REST API (src/routes.ts) - Express routes for document   
+   CRUD                                                     
+ 4 WebSocket layer (src/websocket.ts) - Real-time           
+   collaboration                                            
+ 5 Server factory (src/server.ts) - createApp factory       
+   function                                                 
+
+I'll start with the OT engine since it's the core of the    
+conflict resolution. I need to design operations for insert 
+and delete, then implement transformation logic so that when
+two operations happen concurrently, they can be applied in  
+any order and still produce the same final document state.  
+
+I'm thinking through the standard OT approach where         
+operations are composed of atomic components‚Äîretain to skip 
+characters, insert to add text, and delete to remove        
+characters. The key constraint is that the total input      
+length (retains plus deletes) must match the document       
+length. The transform function takes two concurrent         
+operations and produces transformed versions that satisfy   
+the property where applying them in either order yields     
+identical results.                                          
+
+Actually, I'm going to simplify this. Instead of the        
+composite operation model, I'll use individual insert and   
+delete operations, where each operation specifies a position
+and either text to insert or a count of characters to       
+delete. This is more straightforward to implement and reason
+about. Now I need to work through the transformation rules  
+for different combinations of these operations‚Äîwhen both are
+inserts at different positions, I adjust the second         
+operation's position based on the first's text length, and I
+need to handle the case where they insert at the same       
+position.                                                   
+
+For mixed insert and delete operations, the logic gets more 
+complex depending on whether the insert position falls      
+within the deleted range, but I think the composite         
+operation approach from ot.js would actually be cleaner     
+here. Let me switch to that instead‚Äîit represents an        
+operation as a sequence of retain counts and insert strings,
+which handles transformations more elegantly. Defining the  
+operation types and transform rules...                      
+
+Now I'm working through the cases for how operations        
+interact. When both are deletes, overlapping ranges get     
+tricky, so I'm reconsidering whether a composite operation  
+approach would be cleaner than trying to handle all the edge
+cases individually.                                         
+
+Let me step back and implement a proper Operational         
+Transform system with a clear operation model. I'm defining 
+insert and delete as the two basic operation types, then    
+building out the transformation logic to handle how each    
+type interacts with the other.                              
+
+Defining the transform function... I'm realizing that       
+splitting operations when a delete spans an insert point    
+gets complicated quickly. Let me step back and use a cleaner
+approach‚ÄîI'll model operations as arrays of components,     
+where each component is either a retain count, a string to  
+insert, or a delete count. This way I can handle all the    
+edge cases without needing to split operations into multiple
+pieces.                                                     
+
+Implementing the transform function... I need to think      
+through this more carefully. The transform function takes   
+two operations that both apply to the same document, and I  
+need to return transformed versions where op1' applies to   
+the result of op2, and op2' applies to the result of op1,   
+such that both produce the same final document. When op1    
+retains while op2 deletes, I can't just retain in the result
+since the document is shorter after the deletion‚ÄîI need to  
+reconsider how these cases interact.                        
+
+The algorithm processes both operations in lockstep,        
+maintaining pointers and current components, with helper    
+functions to fetch the next component from each operation   
+while handling any buffered components that couldn't be     
+fully consumed in the previous iteration.                   
+
+Now I'm handling the three cases that arise during the      
+transformation: when an insert appears in the first         
+operation, I push it to the result and convert the          
+corresponding component from the second operation to a      
+retain; when an insert appears in the second operation, I do
+the reverse; and when both operations are retains, I take   
+the minimum length and push it to both results.             
+
+For the remaining length after processing the minimum, I'm  
+updating the operation components if there's anything left  
+over. Then I'm working through the case where the first     
+operation retains while the second deletes‚ÄîI need to figure 
+out what the transformed operations should be when          
+characters are deleted by the second operation but retained 
+by the first.                                               
+
+Looking at the standard operational transformation          
+algorithm, I realize the key is that both operations are    
+applied to the same input document, so I need to walk       
+through them simultaneously. When one operation inserts     
+text, it doesn't consume input characters, so the insert    
+goes into the result as-is while the other operation gets a 
+retain to skip past those inserted characters. The same     
+logic applies when the second operation inserts.            
+
+For retains on both sides, I consume the minimum and both   
+results get a retain. When the first operation retains but  
+the second deletes, I consume the minimum of the retain     
+length and deletion length‚Äîthe first result skips those     
+characters since they're gone after the second operation,   
+while the second result still needs to delete them. And when
+the first operation deletes...                              
+
+Now I'm thinking through the symmetric case where the first 
+operation deletes and the second retains, then the case     
+where both delete the same characters so neither result     
+needs to do anything. Let me start implementing this        
+properly with a clear file structure for the server,        
+database, operational transform engine, routes, websocket   
+manager, and type definitions.                              
+
+Writing the implementation...                               
+
+I'm working through the WebSocket protocol design where     
+clients send operations with their base version number, and 
+the server transforms incoming operations against any       
+operations that happened after that version, maintaining the
+document content, version history, and operation log in the 
+database.                                                   
+
+Defining the TypeScript types... Writing utility            
+functions... Writing the apply function... Writing the      
+transform function... Writing the operation composition     
+logic... Still writing conflict resolution logic... Still   
+writing validation logic...                                 
+
+I'm realizing the validation needs to account for how       
+clients actually send operations‚Äîlike when someone types a  
+character at position 5 in a 10-character document, they'd  
+send the retain count, the inserted text, and then the      
+remaining retain count to match the document length.        
+
+The question is whether to require strict matching of the   
+base length or allow trailing retains to be omitted for     
+convenience. I think I'll keep it strict to prevent bugs,   
+even if it's slightly less convenient for clients.          
+
+Actually, many OT implementations do allow omitting trailing
+retains‚Äîthe operation just needs to be padded to match the  
+document length. I'm writing a helper function that         
+validates the operation length and adds an implicit retain  
+at the end if needed, ensuring the base length matches the  
+document length.                                            
+
+I'm reconsidering the protocol design. Supporting batches of
+simple insert/delete operations would complicate the        
+transform logic significantly, so I'm going to stick with   
+composite operations as the standard format. Clients will   
+send operations in this well-established OT model, which    
+keeps everything consistent and easier to reason about.     
+
+Now I need to think through the server architecture. I'll   
+use Express for REST routes with an HTTP server underneath, 
+then attach the WebSocket server to handle upgrades on paths
+like /ws/:documentId. For the active connections, I'll track
+them in-memory since they're transient, though the schema   
+has a table for it if needed later.                         
+
+There's a subtle issue I need to handle: when the server    
+receives an operation from a client at version V, it needs  
+to validate and process that correctly...                   
+
+Actually, let me reconsider the transformation logic. When  
+an incoming operation arrives at version V, I need to       
+transform it against all the server operations that came    
+after it. I take the incoming op and transform it against   
+each historical operation in sequence, keeping only the     
+transformed result each time and discarding the second      
+return value from the transform function.                   
+
+Now I'm confident in this approach and ready to start       
+implementing. I'll need to set up type definitions, build   
+out the operational transformation engine with apply and    
+transform functions, create a database layer for            
+persistence, set up REST API routes, implement WebSocket    
+handling for real-time collaboration, and tie it all        
+together in the main server file.                           
+
+Setting up the database layer... Setting up the document    
+creation method...                                          
+
+Now I'm thinking through the version tracking system‚Äîeach   
+document starts at version 0 with its initial content, and  
+every operation increments the version number. The versions 
+table captures both the resulting content and the operation 
+that produced it, with version 0 having a null operation    
+since it's the starting point. When clients connect, they'll
+receive the current content and presumably the full version 
+history to reconstruct the document state.                  
+
+I'm planning out the API endpoints now: REST routes for     
+creating, listing, retrieving, updating, and deleting       
+documents, plus a dedicated endpoint for viewing version    
+history. For the WebSocket connection, clients will connect 
+to a document-specific endpoint and receive an initial sync 
+message with the current content and version, then send     
+operations that reference their base version to ensure      
+consistency.                                                
+
+I'm designing a CollaborationManager class to track active  
+WebSocket connections grouped by document and maintain the  
+version state and operation history in memory. I need to    
+make sure operations are both cached for quick              
+transformation during the session and persisted to the      
+database for durability.                                    
+
+I'm thinking through the synchronization strategy between   
+the in-memory cache and the database to keep them           
+consistent.                                                 
+
+Now I need to handle several edge cases: operations with    
+invalid versions, malformed operations, requests for        
+non-existent documents, rapid successive operations from the
+same client, and client disconnections. I'm also adding a   
+unique client ID to the WebSocket protocol for better       
+operation tracking.                                         
+
+I should also consider what happens when content gets       
+modified through a REST API endpoint instead of through the 
+collaborative editing system. I'm settling on allowing PUT  
+requests to update both title and content, with a re-sync   
+mechanism for any active WebSocket clients when content     
+changes. Now I need to write out all the code‚ÄîI'll structure
+it across type definitions, the OT engine, database layer,  
+REST routes, WebSocket collaboration manager, and the main  
+server file.                                                
+
+For the database setup, I'll inline the schema directly     
+rather than dealing with file imports in ESM. On the server 
+side, I'm setting up the typical pattern where an HTTP      
+server handles both Express routes and WebSocket upgrades,  
+parsing the document ID from the WebSocket URL path to route
+connections to the right collaboration manager.             
+
+Setting up server integration... Defining the message       
+types... Writing the normalize function... Writing the      
+transform function... Writing merge logic... Still writing  
+the comparison logic... I'm finishing the validation        
+function and now reconsidering the transform logic when both
+operations delete the same characters. Let me trace through 
+a concrete example to make sure the behavior is correct: if 
+both operations delete overlapping sections, those          
+characters should already be gone, so the transformed       
+operations shouldn't need to do anything for those          
+positions.                                                  
+
+Working through the specific case where op1 deletes         
+positions 1-2 and op2 deletes positions 2-3, they should    
+together delete positions 1-3, leaving just "ae". Now I'm   
+stepping through the transform algorithm to verify this     
+works correctly.                                            
+
+Continuing the trace: when op1 has a delete operation and   
+op2 retains, I take the minimum of the two lengths and push 
+the delete to the result, leaving a remaining delete to     
+process. Then both operations delete, so I take the minimum 
+again and carry forward the remainder. Finally, op1 retains 
+while op2 deletes, and I'm calculating the minimum of those 
+lengths to determine how much to process in this step.      
+
+Now finishing that step: the minimum is 1, so I push the    
+delete to result2 and have 1 remaining retain from op1. In  
+the next step, both operations retain 1 character, so I push
+that retain to both results. Once both operations are       
+exhausted, I normalize the results to get [1, -1, 1] for    
+both, which correctly transforms "abe" and "ade" both to    
+"ae" by retaining the first character, deleting the middle  
+one, and retaining the last. The transform checks out. Now  
+I'm moving on to trace a concurrent insert example starting 
+with document "ab". ", "Y", 1]) = retain 'aX', insert 'Y',  
+retain 'b' = "aXYb" ‚úì                                       
+
+Both transformations produce "aXYb", so they're consistent. 
+
+Now I'm continuing through the remaining steps of the       
+algorithm, checking that when I apply the transformed       
+operations to their respective starting states, I get the   
+same final result. The normalization process is collapsing  
+consecutive retains into single operations, and the         
+verification confirms both paths converge correctly.        
+
+The key insight here is the tiebreaking rule: when two      
+insertions happen at the same position, op1's insert always 
+comes first. This ensures deterministic behavior across all 
+clients.                                                    
+
+Now I'm setting up the database module...                   
+
+Writing database initialization... Setting up database      
+methods... Writing database methods... Writing the database 
+routes... Writing the REST endpoints... Setting up the      
+collaboration manager class with a sessions map to track    
+active document editing sessions, and initializing the      
+connection handler that will manage WebSocket clients       
+joining a document.                                         
+
+Now I'm retrieving the document from the database and       
+creating a new client session with a unique ID, then sending
+back a sync message with the current document state and     
+version number so the client can get up to speed.           
+
+Setting up message handlers for the WebSocket connection to 
+parse incoming changes and route them to the message        
+handler, while also cleaning up the session when clients    
+disconnect or encounter errors.                             
+
+Now I'm implementing the session retrieval logic that checks
+if a document session already exists, and if not, loads the 
+document from the database along with its operation history 
+to reconstruct the current state.                           
+
+Handling incoming messages... Writing validation logic...   
+Continuing the transform loop, I need to validate the       
+transformed operation against the current content length,   
+then apply it to get the new content. If validation passes, 
+I'll increment the version, update the session content, add 
+the operation to the log, and persist everything to the     
+database.                                                   
+
+Then I'm sending an acknowledgment back to the originating  
+client with the new version, and broadcasting the           
+transformed operation to all other connected clients so they
+stay in sync.                                               
+
+Now I'm realizing there's an issue with how I'm indexing the
+operation log‚Äîversion v's operation is stored at index v-1, 
+but I'm loading operations starting from version 0, which   
+would give me operations for versions 1 and onward. Let me  
+reconsider the indexing logic here. me re-examine. In the   
+DB:                                                         
+
+ ‚Ä¢ Version 0 has no operation (initial state)               
+ ‚Ä¢ Version 1 has the operation that transformed version 0 ‚Üí 
+   version 1                                                
+ ‚Ä¢ Version 2 has the operation that transformed version 1 ‚Üí 
+   version 2                                                
+
+When a client says they're at version V and sends an        
+operation:                                                  
+
+ ‚Ä¢ I need to transform against the operations that produced 
+   versions V+1, V+2, ..., currentVersion                   
+
+So if currentVersion is 5 and clientVersion is 3:           
+
+ ‚Ä¢ Operations needed: those that produced version 4 and 5   
+ ‚Ä¢ Those are at operationLog indices 3 and 4 (0-indexed)    
+
+The operationLog stores all operations starting from version
+1, so operationLog[v-1] gives me the operation that produced
+version v. When I transform the client's operation, I       
+iterate through each server operation from the client's     
+version up to the current version, applying the             
+transformation function each time. I'm getting confused     
+about the exact indexing though‚Äîlet me verify that          
+operationLog[3] really does correspond to the operation that
+moved from version 3 to version 4. the client applies the   
+operation, it needs to be transformed against the server    
+operations that happened in between‚Äîso I'm iterating through
+operationLog from the client's version up to the current    
+server version, applying each transformation in sequence to 
+bring the client's operation up to date.                    
+
+Now I'm checking the indexing when loading from the database
+to make sure operationLog is built correctly: the query     
+returns all operations with version greater than 0, which   
+gives me operations for versions 1 through 5, but I need to 
+map them so that operationLog[v] contains the operation that
+transforms version v to v+1.                                
+
+Since the array is zero-indexed and the operations are      
+ordered by version, the mapping works out perfectly‚Äîops[0]  
+corresponds to operationLog[0], ops[1] to operationLog[1],  
+and so on. When I push a new transformed operation to       
+operationLog after incrementing the version, it gets placed 
+at the correct index, and the database stores it with the   
+new version number. The next time I load from the database, 
+I'll get all the operations back in the right order, so the 
+indexing is consistent.                                     
+
+Now I can move forward with the server implementation.      
+
+Setting up the Express server... I'm setting up the server  
+lifecycle methods‚Äîthe start function listens on a port and  
+resolves with the actual port number, while stop gracefully 
+shuts down the WebSocket server, collaboration manager, and 
+database connection. I'm noticing there might be an issue   
+with how the cleanup is being handled...                    
+
+Actually, the async approach makes sense since Node.js      
+server operations are inherently asynchronous. I should also
+make sure the stop function properly closes all active      
+WebSocket connections before shutting down the server, and I
+need to think about edge cases where REST updates come in   
+while WebSocket sessions are active‚Äîthose should trigger a  
+re-sync to keep everything consistent.                      
+
+For the collaboration manager, I'm realizing that the       
+session's operation log should be the source of truth during
+an active session rather than querying the database every   
+time. But if the server restarts, I need to load the full   
+operation history from the database so clients can still    
+transform their operations correctly. Let me verify that    
+getOrCreateSession is loading all operations from the       
+start...                                                    
+
+Loading operation history from database... I'm checking that
+the UUID import works with Node.js 16+, and thinking through
+whether the start function should return a Promise or be    
+synchronous‚Äîa Promise is the right call since HTTP server   
+listening is inherently async in Node.js. I'll use          
+src/server.ts as the entry point and need to verify the     
+better-sqlite3 type definitions are properly set up.        
+
+Now I'm working through the database initialization and     
+import syntax, making sure esModuleInterop: true handles the
+default import correctly. I should also consider error      
+handling when the database file doesn't exist or the path is
+invalid, and I'm realizing that version 0 operations might  
+be null, so I need to make sure my query properly filters   
+those out. fine. I'll keep it simple and trust that version 
+0 is the only null operation, since we never query for it   
+anyway.                                                     
+
+Now I'm ready to write out all the files. One more thing to 
+consider: in collaboration.ts, I need to validate incoming  
+operations before transforming them. The client's operation 
+is based on an older document version, so I need to know the
+document length at that point to validate properly. Rather  
+than storing document lengths at each version, I'll validate
+after the transform completes‚Äîif the transformed operation  
+doesn't match the current content length, I'll reject it.   
+
+Actually, I'm already doing this validation against the     
+current document. But I should also check that the operation
+components themselves are well-formed before transforming.  
+Adding a format check...                                    
+
+Validating operation format...                              
+
+Now I'm thinking about testing. The task mentions tests will
+help, so I should plan out what test cases I need to cover  
+for the OT engine.                                          
+
+I'll organize tests across a few key areas: the core OT     
+operations like apply and transform, the REST API endpoints 
+for CRUD operations, WebSocket integration including        
+connection and synchronization, and concurrent editing      
+scenarios with multiple clients to verify conflict          
+resolution works correctly. I'll set up a tests directory   
+using vitest for this.                                      
+
+Looking back at the tsconfig, it already excludes tests from
+compilation which is fine since vitest handles TypeScript on
+its own.                                                    
+
+I should also consider the clientId in the sync message‚Äîwhen
+a client connects, they get assigned an ID along with the   
+current document state, which lets them filter out their own
+operations when they're broadcast back. And while the task  
+doesn't mention cursor or selection state, I'll keep the    
+protocol focused on just operations for now.                
+
+Let me start writing all the implementation files.          
+
+One thing I need to clarify about the server setup: the app 
+property should be the Express app itself so tests can use  
+supertest with it, while the HTTP server wraps around it.   
+REST tests can use supertest directly with the app, but     
+WebSocket tests will need to connect to the actual running  
+server on its assigned port. So when I call start(0) for a  
+random port, the WebSocket tests connect there while REST   
+tests use supertest.                                        
+
+Writing the implementation... Stopping the server cleanly   
+requires closing everything in the right order‚ÄîWebSocket    
+connections, the WebSocket server, the HTTP server, and     
+finally the database‚Äîthough I need to be careful about how  
+server.close() handles existing connections. For the start  
+method, returning a Promise<number> makes sense since       
+listening is inherently async in Node.js. Now I'm ready to  
+write out all the files with precise types and imports.     
+
+With "module": "Node16" in the TypeScript config, I need to 
+use .js extensions in import paths even though the source   
+files are .ts‚Äîthat's how TypeScript's Node16 resolution     
+works at runtime. Let me trace through the normalize        
+function with a few edge cases to make sure the logic       
+handles empty arrays, zeros, and empty strings correctly.   
+
+Writing the implementation...                               
+
+Now I'm validating edge cases: an empty operation on an     
+empty document is valid since there's nothing to do, but an 
+empty operation on a non-empty document correctly fails     
+because you'd need at least a retain to account for the     
+existing content. I'm also thinking about how the           
+collaboration manager should handle REST updates that modify
+content while WebSocket sessions are active, so I'll add a  
+notification method that routes can call to sync changes    
+across connected clients. I'm realizing that allowing REST  
+updates while WebSocket sessions are active creates a       
+version mismatch problem, so I'll just prevent REST PUT     
+requests when there are active sessions to keep things      
+simple for this collaboration feature. I'm overthinking     
+this. Let me just set up the server entry point to export   
+createApp so tests can import it cleanly, make sure the     
+middleware order is correct with express.json() before the  
+routes, and add proper error handling middleware.           
+
+For the stop() method, I need to handle WebSocket cleanup by
+closing all connections and then shutting down the HTTP     
+server, forcing a quick shutdown for tests.                 
+
+Writing the implementation... I'm keeping the timestamp     
+fields as SQLite returns them with underscores, and the     
+version history endpoint will just return the raw records.  
+Since the requirement allows either src/server.ts or        
+src/index.ts, I'll use src/server.ts as the main entry      
+point. Now I'm thinking through the validation              
+logic‚Äîspecifically whether to be strict about types like    
+NaN, which technically passes typeof checks for numbers but 
+might not be valid data.                                    
+
+Checking for finite integers...                             
+
+Now I need to figure out the right import syntax for the ws 
+package. Since it's a CommonJS module, the default export is
+the WebSocket class itself, and WebSocketServer is a named  
+export, so I should import both together to get the runtime 
+class I need for checking readyState. Checking the type     
+definitions more carefully to figure out the right import   
+pattern with Node16 module resolution and esModuleInterop   
+enabled. I'm settling on importing WebSocket as a type-only 
+import since I only need it for parameter annotations in the
+collaboration module, not for creating instances.           
+
+For the readyState check, I'll use the numeric value 1      
+directly instead of trying to access WebSocket.OPEN on the  
+instance, which keeps the imports cleaner.                  
+
+Now I'm mapping out the file structure and planning what    
+goes in each module. I need to settle on the test directory 
+structure‚Äîvitest handles TypeScript independently, so I can 
+safely put tests in a root tests/ folder to keep the source 
+clean. Now I'm ready to actually write the implementation,  
+starting with the module imports. I'm using direct imports  
+from the ws package with a numeric constant for the         
+WebSocket ready state to avoid any import complexity, then  
+I'll write out all the files.                               
+
+Writing the implementation files... going to create all     
+source files.                                               
+
+Wait, one tiny thing - I should also handle 'Content-Type': 
+'application/json' properly in Express. The express.json()  
+middleware handles parsing. But I should also set the       
+default response content type... Express does this          
+automatically for res.json(). Good.                         
+
+Let me also make sure my route handlers don't have async    
+issues. Express 4 doesn't handle async errors automatically.
+I should use try/catch or wrap handlers. But since I'm not  
+doing async operations (better-sqlite3 is synchronous), I   
+don't need to worry about this.                             
+
+FINAL CODE TIME. Let me write everything now.               
+
+For the tests, I think I'll write comprehensive tests that  
+cover the OT operations, REST API endpoints, WebSocket      
+messaging, and concurrent editing scenarios with multiple   
+clients to verify convergence. I also need to make sure my  
+stop() function properly cleans up all TCP connections and  
+closes the server, otherwise tests might hang. I'm setting  
+up connection tracking so I can destroy all sockets and     
+clear resources when stopping.                              
+
+Implementing cleanup logic... Handling different data       
+types... I'm settling on using .toString() directly since   
+the WebSocket library sends Buffer objects in practice,     
+which handles UTF-8 conversion cleanly. Now I'm ready to    
+write out all the files, and I need to remember to          
+URL-decode document IDs in the WebSocket upgrade handler and
+handle the REST routes properly.                            
+
+One key thing I'm adding: when a document gets deleted via  
+REST, I should close all active WebSocket connections for   
+that document, so I'll pass the collaboration manager to the
+router and call a method to close those connections before  
+deleting.                                                   
+
+Actually, to avoid tight coupling, I could use a callback   
+pattern where the router accepts an optional onDelete       
+handler that the server provides, keeping the modules       
+decoupled. But that might be overengineering it‚ÄîI think the 
+simpler approach is to just let stale WebSocket sessions    
+fail gracefully on their next operation, since SQLite's     
+foreign key cascade will clean up the versions anyway and   
+clients can handle the error.                               
+
+On second thought, I should properly close those connections
+when a document gets deleted. Let me restructure this by    
+creating the collaboration manager upfront, then passing it 
+to both the router and the WebSocket upgrade handler so     
+everything has access to it without circular dependencies.  
+
+Restructuring server.ts...                                  
+
+Setting up routes to accept the collaboration manager...    
+
+Now I need to add a method that closes all WebSocket        
+connections for a document and cleans up its session. I'll  
+write a comprehensive test file to cover the main scenarios.
+
+Writing test helpers... Writing test assertions...          
+
+I'm realizing the WebSocket server cleanup needs to be more 
+careful‚Äîwhen I call wss.close(), it stops accepting new     
+connections but leaves existing ones open, so I need to     
+explicitly close all active WebSocket connections first,    
+then destroy the TCP sockets, and finally close the HTTP    
+server and database.                                        
+
+I'm also double-checking the WebSocket readyState constants 
+from the spec to make sure I'm using the right values for   
+connection status checks. So I can use ws.readyState === 1  
+or import the constant. I'll stick with the numeric literal 
+1 and add a comment for clarity rather than complicating the
+type imports.                                               
+
+Alright, time to write all the files at once‚Äîtypes.ts,      
+ot.ts, database.ts, routes.ts, collaboration.ts, and        
+server.ts.                                                  
+
+Let me trace through the version and operation tracking     
+logic to make sure it handles the edge cases correctly. When
+a document is first created, version 0 is stored with empty 
+content. As clients connect and send operations, the session
+loads the latest version from the database and fetches any  
+operations that came after it. The transform loop then      
+replays those operations against incoming client edits to   
+maintain consistency. If a second client sends an operation 
+at an earlier version, the loop will iterate through all    
+stored operations up to the current version and transform   
+the incoming operation accordingly.                         
+
+For server restarts, the session reconstructs with the      
+latest version and all operations up to that point. A stale 
+client sending an operation at an old version would get     
+transformed against the operations that happened after their
+version, which the server has in its log. This handles the  
+graceful degradation case where a client somehow has        
+buffered operations from before the restart.                
+
+I'm also validating edge cases: negative versions get       
+rejected, future versions beyond the current session version
+get rejected. Now I'm ready to implement this.              
+
+Let me trace through an empty document scenario to verify   
+the logic works there too. Starting with an empty string and
+inserting "Hello" should produce "Hello" correctly.         
+
+Now I'm working through what happens when two clients       
+concurrently insert into an empty document‚Äîone inserting    
+"Hello" and the other "World". The transform operation      
+processes the first insert, then handles the second one,    
+tracking the length adjustments properly.                   
+
+Still writing transform logic... Writing the transform      
+function... I'm working through some edge cases with        
+trailing retains and mismatched operation lengths. Let me   
+trace through a specific example where both operations have 
+the same base length of 3 but different structures‚Äîone is a 
+single retain and the other combines retains, inserts, and  
+deletes. I'm stepping through the transformation logic to   
+see how the algorithm handles consuming operations when one 
+runs out before the other. merge to 4                       
+
+So result1 = [4]. result2 = [2, "x", 1] ‚Üí normalize ‚Üí [2,   
+"x", 1] (no merging needed since types alternate).          
+
+Let me verify this works both ways:                         
+
+ ‚Ä¢ Document: "abc" (length 3)                               
+ ‚Ä¢ op1: [3] = retain all = "abc" (no-op)                    
+ ‚Ä¢ op2: [2, "x", 1] = retain "ab", insert "x", retain "c" = 
+   "abxc"                                                   
+
+After op2: "abxc" (length 4) apply("abxc", [4]) = "abxc" ‚úì  
+(op1' is a no-op on longer doc)                             
+
+After op1: "abc" (length 3) apply("abc", [2, "x", 1]) =     
+"abxc" ‚úì (op2' is same as op2)                              
+
+Both paths converge to "abxc" ‚úì                             
+
+The transform is working correctly. Now I'm ready to write  
+the actual implementation. I'll create all 6 source files   
+plus the test file, starting with a named export createApp  
+from the server module that consumers can import directly. I
+need to verify the Express types handle json() middleware   
+properly and check the imports for http and net modules.    
+
+Writing the implementation files now... I'm settling on a   
+single comprehensive test file to keep things organized, and
+I need to adjust my file structure since the TypeScript     
+config has src as the root directory and dist as the        
+output‚Äîtests should live outside src. Let me finalize my    
+file list: types, OT logic, database layer, routes,         
+collaboration handler, main server, and then the test suite.
+
+Now I'm thinking through the Express types                  
+carefully‚Äîreq.params is a string map, req.body is untyped by
+default, and the response methods handle status codes and   
+JSON serialization. I'll import the Router from Express and 
+let TypeScript infer the handler types naturally rather than
+explicitly annotating them.                                 
+
+One thing to watch: req.body needs type assertion since it  
+defaults to any, and the correct chaining for responses is  
+res.status(201).json(data) or res.status(204).send() for    
+no-content. I'll use the named import approach with Router()
+directly.                                                   
+
+Writing the route handlers now... Express route handlers. In
+strict mode, the handler's return type matters. Express     
+handlers should not return a value (void). But with         
+TypeScript strict mode, if the handler returns res.json(...)
+which returns Response, TypeScript might complain.          
+
+In Express 4 with @types/express, route handlers can return 
+anything (the return value is ignored). So return           
+res.json(data) is fine. The type system won't complain as   
+long as the function signature matches.                     
+
+Actually, looking at Express route handler types, the return
+type is void. In TypeScript, void means the return value is 
+ignored, not that you can't return something. So return     
+res.status(404).json(...) is fine.                          
+
+When using router.get('/path', (req, res) => { ... }),      
+TypeScript infers the handler type from the Router method   
+overloads. The parameter types are inferred, and the return 
+type is expected to be void. Returning res.json() (which    
+returns Response) might cause a type error in strict mode. I
+can either omit the return statement, cast it as void, or   
+just not worry about it since it's usually fine. Let me just
+keep it simple and not return the value.                    
+
+For conditional responses, I'll use early returns with      
+return; to exit the handler after sending the response. This
+keeps the code clean and avoids nested if-else blocks.      
+
+Now I'm ready to write the code. I also need to add a       
+timeout to the stop() method in case server.close() hangs   
+indefinitely.                                               
+
+Writing the server implementation...                        
+
+For the timeout safety net, I'm setting it to 1 second since
+socket.destroy() should force everything to close quickly   
+anyway. Since Promise only resolves once, calling resolve   
+multiple times is harmless‚Äîthe subsequent calls just get    
+ignored.                                                    
+
+Now I'm writing the comprehensive concurrency test that     
+creates a document via REST, connects multiple WebSocket    
+clients to it, sends concurrent operations from each client,
+and verifies they all converge to the same final state.     
+
+Writing test code... Writing test assertions...             
+
+I'm setting up message collection from both clients and then
+verifying the final document state through a REST call to   
+ensure both concurrent edits converged properly. The test   
+intentionally sends operations without waiting to simulate  
+true concurrent editing, relying on the server's sequential 
+processing to handle the race condition‚Äîthough I need to    
+think through what the final state should be depending on   
+which operation gets processed first.                       
+
+Now I'm working through the transformation logic when the   
+second client's operation gets processed after the first.   
+Both clients insert at position 0, so I need to transform   
+the second operation against the first using operational    
+transformation rules. The transformation adjusts the        
+positions and content based on what was already applied,    
+ultimately producing a merged result where both insertions  
+are preserved in the final document. I'm realizing I need a 
+more deterministic test where the operations don't          
+overlap‚Äîhaving client 1 insert at the beginning and client 2
+insert at the end means the transformations will be         
+straightforward regardless of processing order, so both     
+clients will converge on the same final state. I'm working  
+through the transformation logic step by step‚Äîwhen client   
+2's retain operation meets client 1's insert, I push the    
+insert to both results and continue. Then both operations   
+retain the same length, so I advance through both. Finally, 
+client 1 has an insert remaining that needs to be added.    
+
+After normalizing the results, I get [4, "Y"] and ["X", 4], 
+which both converge to "XabcY" when applied to their        
+respective document states. Now I'm checking the reverse    
+scenario where client 2 applies their operation first,      
+resulting in "abcY", and seeing how client 1's original     
+operation transforms against it. The transformations        
+converge correctly‚Äîboth orderings produce "XabcY", which    
+confirms that non-overlapping inserts at different positions
+resolve consistently. Now I want to test sequential OT where
+the first operation gets acknowledged before the second one 
+is sent, to verify the system handles dependent operations  
+properly.                                                   
+
+Then I'll run a concurrent test where both clients send     
+simultaneously to check convergence under that scenario too.
+
+Writing the test files now. I need to set up a WebSocket    
+connection helper that properly waits for the connection to 
+open before resolving, accounting for the timing of when the
+ws library fires its events.                                
+
+Let me structure this: write all six source files at once,  
+then build and test everything together rather than doing it
+incrementally. For the better-sqlite3 import, I'll use the  
+standard ESM syntax with import Database from               
+'better-sqlite3' and instantiate it directly. I'm checking  
+the @types/ws definitions to see whether WebSocket.Server or
+WebSocket.WebSocketServer is the right way to instantiate   
+the server class, and it looks like Server is the actual    
+class while WebSocketServer is just a type alias for it, so 
+I should use new WebSocket.Server() with the noServer       
+option. I need to verify my transform function handles the  
+case where both operations delete the same range correctly. 
+Let me trace through an example where the document is       
+"abcde" and both operations delete everything with [-5].    
+After transformation, both should result in empty operations
+that normalize to [], and applying either to an empty       
+document gives an empty result, so they converge properly.  
+I'm also checking another scenario where one operation      
+deletes and retains while the other does the opposite. they 
+together delete everything, which checks out.               
+
+I'm confident the OT implementation is solid now, so I'm    
+ready to start writing code. For the entry point, I'll      
+export the createApp factory from src/server.ts as the      
+requirement specifies. I need to handle the TypeScript      
+typing for http.createServer accepting Express's app object,
+which works as both a handler and an Application instance.  
+
+Now I'm checking the WebSocket upgrade event types‚Äîthe      
+wss.handleUpgrade method and the server.on('upgrade')       
+callback need to align, though there might be a subtle type 
+mismatch with how the socket parameter is typed.            
+
+I also need to handle a couple of edge cases: request.url   
+could be undefined, so I'll provide a fallback, and         
+decodeURIComponent might throw on malformed input, so I'll  
+wrap that in error handling to safely destroy the socket if 
+parsing fails.                                              
+
+Writing the implementation now...                           
+
+Actually, let me plan out the file structure. I'll write the
+type definitions and operational transform logic first, then
+the database and route handlers, followed by the            
+collaboration and server modules. Since some files depend on
+others, I can batch the independent ones together and build 
+incrementally to catch any issues. Now I'm mapping out the  
+remaining modules‚Äîeach file has clear responsibilities and I
+need to verify the import structure doesn't create cycles.  
+Routes depends on collaboration and database, collaboration 
+depends on database and the OT engine, and server ties      
+everything together at the top level. The architecture is   
+sound, so I'll proceed with writing all the files at once.[0m
+[90m============================================================[0m
+
+
+[38;5;103m‚ñç[0m [38;5;145mNow I have a clear picture of the project. It's a           [0m
+[38;5;103m‚ñç[0m [38;5;145mpre-configured TypeScript project with Express, ws, and     [0m
+[38;5;103m‚ñç[0m [38;5;145mbetter-sqlite3, with an empty src/ directory and a provided [0m
+[38;5;103m‚ñç[0m [38;5;145mSQL schema. Let me design the architecture and implement    [0m
+[38;5;103m‚ñç[0m [38;5;145meverything.[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 40,612 (88% cached) | Output: 38,703 | Total: 79,315[0m
+
+[36müîß Using tool: todo[0m
+   [2maction: update[0m
+   [2mtodos:[0m
+   [2m- content: Explore existing project structure and configuration[0m
+   [2m  status: completed[0m
+   [2m  activeForm: Exploring existing project structure[0m
+   [2m... (12 more lines)[0m
+[36m‚úÖ Tool result: todo[0m
+[2m   status: updated
+   count: 5
+   pending: 3
+   in_progress: 1
+   completed: 1[0m
+
+
+[2;37m‚îå‚îÄ Todo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;32m‚úì[0m [2;32mExplore existing project structure and configuration[0m     [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [1;36m‚ñ∂[0m [1;36mImplementing all source files[0m                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mBuild and fix any compilation errors[0m                     [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mWrite comprehensive tests[0m                                [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mRun tests and verify everything works[0m                    [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [32m‚ñà‚ñà‚ñà‚ñà[0m[2;37m‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë[0m 1/5                               [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò[0m
+
+[38;5;103m‚ñç[0m [38;5;145mNow I have a clear picture of the project. Let me implement [0m
+[38;5;103m‚ñç[0m [38;5;145mall source files. The project has TypeScript + Express + ws [0m
+[38;5;103m‚ñç[0m [38;5;145m+ better-sqlite3 with ESM modules, an existing SQL schema,  [0m
+[38;5;103m‚ñç[0m [38;5;145mand an empty src/ directory.                                [0m
+[38;5;103m‚ñç[0m [38;5;145m[0m
+[38;5;103m‚ñç[0m [38;5;145mI'll write all 6 source files in parallel:[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 78,311 (46% cached) | Output: 506 | Total: 78,817[0m
+
+[36müîß Using tool: write_file[0m
+   [2mfile_path: /workspace/src/types.ts[0m
+   [2mcontent: |[0m
+   [2m    // OT operation components:[0m
+   [2m    // - positive number = retain N characters[0m
+   [2m    // - string = insert that string[0m
+   [2m... (60 more lines)[0m
+[36m‚úÖ Tool result: write_file[0m
+[2m   file_path: /workspace/src/types.ts
+   bytes: 1277[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 78,856 (45% cached) | Output: 2,236 | Total: 81,092[0m
+
+[36müîß Using tool: write_file[0m
+   [2mfile_path: /workspace/src/ot.ts[0m
+   [2mcontent: |[0m
+   [2m    import type { TextOperation, OpComponent } from './types.js';[0m
+   [2m    [0m
+   [2m    /** Calculate the base length (input document length) of an operation */[0m
+   [2m... (210 more lines)[0m
+[36m‚úÖ Tool result: write_file[0m
+[2m   file_path: /workspace/src/ot.ts
+   bytes: 6292[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 81,133 (44% cached) | Output: 1,258 | Total: 82,391[0m
+
+[36müîß Using tool: write_file[0m
+   [2mfile_path: /workspace/src/database.ts[0m
+   [2mcontent: |[0m
+   [2m    import Database from 'better-sqlite3';[0m
+   [2m    import type { DocumentRecord, VersionRecord, TextOperation } from './types.js';[0m
+   [2m    [0m
+   [2m... (128 more lines)[0m
+[36m‚úÖ Tool result: write_file[0m
+[2m   file_path: /workspace/src/database.ts
+   bytes: 4152[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 82,430 (43% cached) | Output: 2,201 | Total: 84,631[0m
+
+[36müîß Using tool: write_file[0m
+   [2mfile_path: /workspace/src/collaboration.ts[0m
+   [2mcontent: |[0m
+   [2m    import type WebSocket from 'ws';[0m
+   [2m    import type { DocumentDatabase } from './database.js';[0m
+   [2m    import type { TextOperation, ServerMessage } from './types.js';[0m
+   [2m... (260 more lines)[0m
+[36m‚úÖ Tool result: write_file[0m
+[2m   file_path: /workspace/src/collaboration.ts
+   bytes: 7241[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 84,670 (42% cached) | Output: 719 | Total: 85,389[0m
+
+[36müîß Using tool: write_file[0m
+   [2mfile_path: /workspace/src/routes.ts[0m
+   [2mcontent: |[0m
+   [2m    import { Router } from 'express';[0m
+   [2m    import { randomUUID } from 'crypto';[0m
+   [2m    import type { DocumentDatabase } from './database.js';[0m
+   [2m... (74 more lines)[0m
+[36m‚úÖ Tool result: write_file[0m
+[2m   file_path: /workspace/src/routes.ts
+   bytes: 2037[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 85,428 (42% cached) | Output: 807 | Total: 86,235[0m
+
+[36müîß Using tool: write_file[0m
+   [2mfile_path: /workspace/src/server.ts[0m
+   [2mcontent: |[0m
+   [2m    import express from 'express';[0m
+   [2m    import http from 'http';[0m
+   [2m    import WebSocket from 'ws';[0m
+   [2m... (95 more lines)[0m
+[36m‚úÖ Tool result: write_file[0m
+[2m   file_path: /workspace/src/server.ts
+   bytes: 2568[0m
+
+
+[90m============================================================[0m
+[90mThinking:[0m
+[90m------------------------------------------------------------[0m
+[2mGood, all source files are written. Now let me build and    
+check for compilation errors.[0m
+[90m============================================================[0m
+
+
+[38;5;110m‚ñ∏[0m [38;5;188mNow let me build and check for compilation errors:[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 86,274 (41% cached) | Output: 253 | Total: 86,527[0m
+
+[36müîß Using tool: todo[0m
+   [2maction: update[0m
+   [2mtodos:[0m
+   [2m- content: Explore existing project structure and configuration[0m
+   [2m  status: completed[0m
+   [2m  activeForm: Exploring existing project structure[0m
+   [2m... (12 more lines)[0m
+[36m‚úÖ Tool result: todo[0m
+[2m   status: updated
+   count: 5
+   pending: 2
+   in_progress: 1
+   completed: 2[0m
+
+
+[2;37m‚îå‚îÄ Todo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;32m‚úì[0m [2;32mExplore existing project structure and configuration[0m     [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;32m‚úì[0m [2;32mImplement all source files[0m                               [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [1;36m‚ñ∂[0m [1;36mBuilding and fixing errors[0m                               [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mWrite comprehensive tests[0m                                [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [2;37m‚óã[0m [2;37mRun tests and verify everything works[0m                    [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m [32m‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà[0m[2;37m‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë[0m 2/5                               [2;37m‚îÇ[0m
+[2;37m‚îÇ[0m                                                            [2;37m‚îÇ[0m
+[2;37m‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò[0m
+
+[38;5;110m‚ñ∏[0m [38;5;188mNow let me build and fix any compilation errors:[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 86,556 (41% cached) | Output: 73 | Total: 86,629[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && npm run build 2>&1[0m
+[36m‚ùå Tool result: bash[0m
+[2m   
+   > bench-collab-server@1.0.0 build
+   > tsc
+   
+   sh: 1: tsc: not found
+   ... (1 more lines)[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 86,692 (41% cached) | Output: 63 | Total: 86,755[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && npx tsc 2>&1[0m
+[36m‚ùå Tool result: bash[0m
+[2m   npm warn exec The following package was not found and will be installed: tsc@2.0.4
+   
+   [41m                                                                               [0m
+   [41m[37m                This is not the tsc command you are looking for                [0m
+   [41m                                                                               [0m
+   ... (6 more lines)[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 86,997 (41% cached) | Output: 68 | Total: 87,065[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && ./node_modules/.bin/tsc 2>&1[0m
+[36m‚ùå Tool result: bash[0m
+[2m   /bin/bash: line 1: ./node_modules/.bin/tsc: No such file or directory
+   [0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 87,116 (41% cached) | Output: 71 | Total: 87,187[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && ls node_modules/.bin/ | grep -i type 2>&1[0m
+[36m‚ùå Tool result: bash[0m
+[2m   [stderr]: ls: cannot access 'node_modules/.bin/': No such file or directory
+   [0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 87,233 (41% cached) | Output: 61 | Total: 87,294[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && npm install 2>&1[0m
+[36m‚úÖ Tool result: bash[0m
+[2m   npm warn deprecated rimraf@3.0.2: Rimraf versions prior to v4 are no longer supported
+   npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
+   npm warn deprecated glob@7.2.3: Old versions of glob are not supported, and contain widely publicized security vulnerabilities, which have been fixed in the current version. Please update. Support for old versions may be purchased (at exorbitant rates) by contacting i@izs.me
+   npm warn deprecated @humanwhocodes/object-schema@2.0.3: Use @eslint/object-schema instead
+   npm warn deprecated @humanwhocodes/config-array@0.13.0: Use @eslint/config-array instead
+   ... (18 more lines)[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 87,763 (41% cached) | Output: 62 | Total: 87,825[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && npm run build 2>&1[0m
+[36m‚ùå Tool result: bash[0m
+[2m   
+   > bench-collab-server@1.0.0 build
+   > tsc
+   
+   src/server.ts(24,29): error TS2339: Property 'Server' does not exist on type 'typeof WebSocket'.
+   ... (2 more lines)[0m
+
+
+[90m============================================================[0m
+[90mThinking:[0m
+[90m------------------------------------------------------------[0m
+[2mI need to fix the TypeScript compilation errors in          
+server.ts. The issues are:                                  
+
+ 1 WebSocket.Server doesn't exist on typeof WebSocket - I   
+   need to use WebSocket.WebSocketServer or import          
+   differently                                              
+ 2 Implicit any type for the ws parameter in handleUpgrade  
+   callback                                                 
+
+Let me fix the import and usage.[0m
+[90m============================================================[0m
+
+
+[38;5;110m‚ñ∏[0m [38;5;188mLet me fix the TypeScript errors in server.ts:[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 87,942 (41% cached) | Output: 173 | Total: 88,115[0m
+
+[36müîß Using tool: read_file[0m
+   [2mfile_path: /workspace/src/server.ts[0m
+[36m‚úÖ Tool result: read_file[0m
+[2m   file_path: /workspace/src/server.ts
+   content: |
+            1	import express from 'express';
+            2	import http from 'http';
+            3	import WebSocket from 'ws';
+   ... (97 more lines)[0m
+
+
+[90m============================================================[0m
+[90mThinking:[0m
+[90m------------------------------------------------------------[0m
+[2mI need to fix the TypeScript errors. The issue is with      
+WebSocket.Server not existing on the type. Let me check     
+what's available in the @types/ws package and fix the       
+import.[0m
+[90m============================================================[0m
+
+
+[38;5;110m‚ñ∏[0m [38;5;188mLet me fix the TypeScript errors. The ws module's types need[0m
+  [38;5;188ma different import pattern:[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 89,368 (40% cached) | Output: 168 | Total: 89,536[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && grep -n "Server\|WebSocketServer" node_modules/@types/ws/index.d.ts 2>&1 | head -30[0m
+[36m‚úÖ Tool result: bash[0m
+[2m   10:    Server as HTTPServer,
+   12:import { Server as HTTPSServer } from "https";
+   259:        checkServerIdentity?(servername: string, cert: CertMeta): boolean;
+   327:    interface ServerOptions<
+   334:        server?: HTTPServer<V> | HTTPSServer<V> | undefined;
+   ... (26 more lines)[0m
+
+
+[90m============================================================[0m
+[90mThinking:[0m
+[90m------------------------------------------------------------[0m
+[2mI can see that WebSocket.Server is actually Server in the   
+namespace, and WebSocketServer is a const alias. Let me fix 
+the import to use the correct approach. The type definitions
+show that Server is the class in the WebSocket namespace,   
+and WebSocketServer is a const alias.                       
+
+The issue is that with export = WebSocket, the namespace    
+members are accessible as WebSocket.Server, but TypeScript  
+might not recognize it with the default import pattern.     
+
+Let me try using WebSocketServer as a named-ish import.     
+Actually, looking at the types again:                       
+
+                                                            
+ const WebSocketServer: typeof Server;                      
+                                                            
+
+This is inside the WebSocket namespace.                     
+
+So the problem is that with export = WebSocket, the         
+namespace members live on the value itself, not the type. I 
+should try importing WebSocketServer directly as a named    
+export, or destructure it from the default import to access 
+it properly. I'm wondering if WebSocketServer can be        
+imported as a named export directly, or if I need to use    
+dynamic import syntax instead. Looking at the type          
+definitions, WebSocketServer is declared within the         
+namespace, so with export = and Node16 module resolution,   
+named imports might not resolve properly‚ÄîI should test      
+importing it directly as a named export first. I'm wrestling
+with how to properly import WebSocketServer from the ws     
+package given the type declarations use export = pattern.   
+Named imports should work with esModuleInterop and Node16   
+resolution, but I've run into issues before, so let me just 
+go with a simpler approach using a type assertion instead.  
+
+Actually, the cleanest solution is to import WebSocketServer
+directly as a named import and separately import the        
+WebSocket type, then instantiate the server with new        
+WebSocketServer({ noServer: true }) and explicitly type the 
+ws parameter as WebSocket.[0m
+[90m============================================================[0m
+
+
+[38;5;110m‚ñ∏[0m [38;5;188mI see the issue - WebSocket.Server isn't directly accessible[0m
+  [38;5;188mwith Node16 module resolution. Let me fix the imports:[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 90,321 (39% cached) | Output: 1,549 | Total: 91,870[0m
+
+[36müîß Using tool: edit_file[0m
+   [2mfile_path: /workspace/src/server.ts[0m
+   [2mold_string: |[0m
+   [2m    import express from 'express';[0m
+   [2m    import http from 'http';[0m
+   [2m    import WebSocket from 'ws';[0m
+   [2m... (13 more lines)[0m
+[36m‚úÖ Tool result: edit_file[0m
+[2m   file_path: /workspace/src/server.ts
+   replacements_made: 1
+   bytes_written: 2611[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 91,858 (39% cached) | Output: 130 | Total: 91,988[0m
+
+[36müîß Using tool: edit_file[0m
+   [2mfile_path: /workspace/src/server.ts[0m
+   [2mold_string: "  const wss = new WebSocket.Server({ noServer: true });"[0m
+   [2mnew_string: "  const wss = new WebSocketServer({ noServer: true });"[0m
+[36m‚úÖ Tool result: edit_file[0m
+[2m   file_path: /workspace/src/server.ts
+   replacements_made: 1
+   bytes_written: 2610[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 92,030 (39% cached) | Output: 170 | Total: 92,200[0m
+
+[36müîß Using tool: edit_file[0m
+   [2mfile_path: /workspace/src/server.ts[0m
+   [2mold_string: |[0m
+   [2m        wss.handleUpgrade(request, socket, head, (ws) => {[0m
+   [2m          collaboration.handleConnection(ws, documentId);[0m
+   [2m        });[0m
+   [2m... (4 more lines)[0m
+[36m‚úÖ Tool result: edit_file[0m
+[2m   file_path: /workspace/src/server.ts
+   replacements_made: 1
+   bytes_written: 2621[0m
+
+[2m‚îÇ  üìä Token Usage[0m
+[2m‚îî‚îÄ Input: 92,242 (39% cached) | Output: 62 | Total: 92,304[0m
+
+[36müîß Using tool: bash[0m
+   [2mcommand: cd /workspace && npm run build 2>&1[0m
+[36m‚úÖ Tool result: bash[0m
+[2m   
+   > bench-collab-server@1.0.0 build
+   > tsc
+   
+   [0m
+
+Error: Error code: 400 - {'type': 'error', 'error': {'type': 
+'invalid_request_error', 'message': 'Your credit balance is too low to access 
+the Anthropic API. Please go to Plans & Billing to upgrade or purchase 
+credits.'}, 'request_id': 'req_011CYAJrJgLRGubMFmdnGSgf'}
diff --git a/.amplifier/settings.local.yaml b/.amplifier/settings.local.yaml
new file mode 100644
index 0000000..64831cc
--- /dev/null
+++ b/.amplifier/settings.local.yaml
@@ -0,0 +1,11 @@
+config:
+  providers:
+  - config:
+      api_key: ${ANTHROPIC_API_KEY}
+      base_url: https://api.anthropic.com
+      default_model: claude-opus-4-6
+      enable_1m_context: 'true'
+      enable_prompt_caching: 'true'
+      priority: 1
+    module: provider-anthropic
+    source: /opt/amplifier-provider-anthropic
diff --git a/.thunderdome-metrics.json b/.thunderdome-metrics.json
new file mode 100644
index 0000000..3dd4f54
--- /dev/null
+++ b/.thunderdome-metrics.json
@@ -0,0 +1,7 @@
+{
+  "input_tokens": 56268,
+  "output_tokens": 62,
+  "cache_read_tokens": 35974,
+  "cache_creation_tokens": 0,
+  "total_cost_usd": 0.902631
+}
\ No newline at end of file
diff --git a/.thunderdome-stderr.log b/.thunderdome-stderr.log
new file mode 100644
index 0000000..71ac40b
--- /dev/null
+++ b/.thunderdome-stderr.log
@@ -0,0 +1,13 @@
+
+[36müß† Thinking...[0m
+
+[36müß† Thinking...[0m
+
+[36müß† Thinking...[0m
+
+[36müß† Thinking...[0m
+
+[36müß† Thinking...[0m
+
+[36müß† Thinking...[0m
+Execution failed: Error code: 400 - {'type': 'error', 'error': {'type': 'invalid_request_error', 'message': 'Your credit balance is too low to access the Anthropic API. Please go to Plans & Billing to upgrade or purchase credits.'}, 'request_id': 'req_011CYAJrJgLRGubMFmdnGSgf'}
diff --git a/package-lock.json b/package-lock.json
index b36b372..6f03430 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -19,12 +19,84 @@
         "@types/ws": "^8.5.0",
         "@typescript-eslint/eslint-plugin": "^7.0.0",
         "@typescript-eslint/parser": "^7.0.0",
+        "@vitest/coverage-v8": "^2.0.0",
         "eslint": "^8.56.0",
         "supertest": "^7.0.0",
         "typescript": "^5.4.0",
         "vitest": "^2.0.0"
       }
     },
+    "node_modules/@ampproject/remapping": {
+      "version": "2.3.0",
+      "resolved": "https://registry.npmjs.org/@ampproject/remapping/-/remapping-2.3.0.tgz",
+      "integrity": "sha512-30iZtAPgz+LTIYoeivqYo853f02jBYSd5uGnGpkFV0M3xOt9aN73erkgYAmZU43x4VfqcnLxW9Kpg3R5LC4YYw==",
+      "dev": true,
+      "license": "Apache-2.0",
+      "dependencies": {
+        "@jridgewell/gen-mapping": "^0.3.5",
+        "@jridgewell/trace-mapping": "^0.3.24"
+      },
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
+    "node_modules/@babel/helper-string-parser": {
+      "version": "7.27.1",
+      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
+      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6.9.0"
+      }
+    },
+    "node_modules/@babel/helper-validator-identifier": {
+      "version": "7.28.5",
+      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.28.5.tgz",
+      "integrity": "sha512-qSs4ifwzKJSV39ucNjsvc6WVHs6b7S03sOh2OcHF9UHfVPqWWALUsNUVzhSBiItjRZoLHx7nIarVjqKVusUZ1Q==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6.9.0"
+      }
+    },
+    "node_modules/@babel/parser": {
+      "version": "7.29.0",
+      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.29.0.tgz",
+      "integrity": "sha512-IyDgFV5GeDUVX4YdF/3CPULtVGSXXMLh1xVIgdCgxApktqnQV0r7/8Nqthg+8YLGaAtdyIlo2qIdZrbCv4+7ww==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@babel/types": "^7.29.0"
+      },
+      "bin": {
+        "parser": "bin/babel-parser.js"
+      },
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
+    "node_modules/@babel/types": {
+      "version": "7.29.0",
+      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.29.0.tgz",
+      "integrity": "sha512-LwdZHpScM4Qz8Xw2iKSzS+cfglZzJGvofQICy7W7v4caru4EaAmyUuO6BGrbyQ2mYV11W0U8j5mBhd14dd3B0A==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@babel/helper-string-parser": "^7.27.1",
+        "@babel/helper-validator-identifier": "^7.28.5"
+      },
+      "engines": {
+        "node": ">=6.9.0"
+      }
+    },
+    "node_modules/@bcoe/v8-coverage": {
+      "version": "0.2.3",
+      "resolved": "https://registry.npmjs.org/@bcoe/v8-coverage/-/v8-coverage-0.2.3.tgz",
+      "integrity": "sha512-0hYQ8SB4Db5zvZB4axdMHGwEaQjkZzFjQiN9LVYvIFB2nSUHW9tYpxWriPrWDASIxiaXax83REcLxuSdnGPZtw==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/@esbuild/aix-ppc64": {
       "version": "0.21.5",
       "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.21.5.tgz",
@@ -565,6 +637,84 @@
       "dev": true,
       "license": "BSD-3-Clause"
     },
+    "node_modules/@isaacs/cliui": {
+      "version": "8.0.2",
+      "resolved": "https://registry.npmjs.org/@isaacs/cliui/-/cliui-8.0.2.tgz",
+      "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "string-width": "^5.1.2",
+        "string-width-cjs": "npm:string-width@^4.2.0",
+        "strip-ansi": "^7.0.1",
+        "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
+        "wrap-ansi": "^8.1.0",
+        "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
+      },
+      "engines": {
+        "node": ">=12"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/ansi-regex": {
+      "version": "6.2.2",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.2.tgz",
+      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/@isaacs/cliui/node_modules/strip-ansi": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.2.tgz",
+      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
+    "node_modules/@istanbuljs/schema": {
+      "version": "0.1.3",
+      "resolved": "https://registry.npmjs.org/@istanbuljs/schema/-/schema-0.1.3.tgz",
+      "integrity": "sha512-ZXRY4jNvVgSVQ8DL3LTcakaAtXwTVUxE81hslsyD2AtoXW/wVob10HkOJ1X/pAlcI7D+2YoZKg5do8G/w6RYgA==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/@jridgewell/gen-mapping": {
+      "version": "0.3.13",
+      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
+      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@jridgewell/sourcemap-codec": "^1.5.0",
+        "@jridgewell/trace-mapping": "^0.3.24"
+      }
+    },
+    "node_modules/@jridgewell/resolve-uri": {
+      "version": "3.1.2",
+      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
+      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=6.0.0"
+      }
+    },
     "node_modules/@jridgewell/sourcemap-codec": {
       "version": "1.5.5",
       "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
@@ -572,6 +722,17 @@
       "dev": true,
       "license": "MIT"
     },
+    "node_modules/@jridgewell/trace-mapping": {
+      "version": "0.3.31",
+      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
+      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@jridgewell/resolve-uri": "^3.1.0",
+        "@jridgewell/sourcemap-codec": "^1.4.14"
+      }
+    },
     "node_modules/@noble/hashes": {
       "version": "1.8.0",
       "resolved": "https://registry.npmjs.org/@noble/hashes/-/hashes-1.8.0.tgz",
@@ -633,6 +794,17 @@
         "@noble/hashes": "^1.1.5"
       }
     },
+    "node_modules/@pkgjs/parseargs": {
+      "version": "0.11.0",
+      "resolved": "https://registry.npmjs.org/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
+      "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
+      "dev": true,
+      "license": "MIT",
+      "optional": true,
+      "engines": {
+        "node": ">=14"
+      }
+    },
     "node_modules/@rollup/rollup-android-arm-eabi": {
       "version": "4.57.1",
       "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.57.1.tgz",
@@ -1081,7 +1253,6 @@
       "integrity": "sha512-m0jEgYlYz+mDJZ2+F4v8D1AyQb+QzsNqRuI7xg1VQX/KlKS0qT9r1Mo16yo5F/MtifXFgaofIFsdFMox2SxIbQ==",
       "dev": true,
       "license": "MIT",
-      "peer": true,
       "dependencies": {
         "undici-types": "~7.16.0"
       }
@@ -1207,7 +1378,6 @@
       "integrity": "sha512-4Z+L8I2OqhZV8qA132M4wNL30ypZGYOQVBfMgxDH/K5UX0PNqTu1c6za9ST5r9+tavvHiTWmBnKzpCJ/GlVFtg==",
       "dev": true,
       "license": "BSD-2-Clause",
-      "peer": true,
       "dependencies": {
         "@typescript-eslint/scope-manager": "7.18.0",
         "@typescript-eslint/types": "7.18.0",
@@ -1368,6 +1538,39 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/@vitest/coverage-v8": {
+      "version": "2.1.9",
+      "resolved": "https://registry.npmjs.org/@vitest/coverage-v8/-/coverage-v8-2.1.9.tgz",
+      "integrity": "sha512-Z2cOr0ksM00MpEfyVE8KXIYPEcBFxdbLSs56L8PO0QQMxt/6bDj45uQfxoc96v05KW3clk7vvgP0qfDit9DmfQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@ampproject/remapping": "^2.3.0",
+        "@bcoe/v8-coverage": "^0.2.3",
+        "debug": "^4.3.7",
+        "istanbul-lib-coverage": "^3.2.2",
+        "istanbul-lib-report": "^3.0.1",
+        "istanbul-lib-source-maps": "^5.0.6",
+        "istanbul-reports": "^3.1.7",
+        "magic-string": "^0.30.12",
+        "magicast": "^0.3.5",
+        "std-env": "^3.8.0",
+        "test-exclude": "^7.0.1",
+        "tinyrainbow": "^1.2.0"
+      },
+      "funding": {
+        "url": "https://opencollective.com/vitest"
+      },
+      "peerDependencies": {
+        "@vitest/browser": "2.1.9",
+        "vitest": "2.1.9"
+      },
+      "peerDependenciesMeta": {
+        "@vitest/browser": {
+          "optional": true
+        }
+      }
+    },
     "node_modules/@vitest/expect": {
       "version": "2.1.9",
       "resolved": "https://registry.npmjs.org/@vitest/expect/-/expect-2.1.9.tgz",
@@ -1500,7 +1703,6 @@
       "integrity": "sha512-NZyJarBfL7nWwIq+FDL6Zp/yHEhePMNnnJ0y3qfieCrmNvYct8uvtiV41UvlSe6apAfk0fY1FbWx+NwfmpvtTg==",
       "dev": true,
       "license": "MIT",
-      "peer": true,
       "bin": {
         "acorn": "bin/acorn"
       },
@@ -2116,12 +2318,26 @@
         "node": ">= 0.4"
       }
     },
+    "node_modules/eastasianwidth": {
+      "version": "0.2.0",
+      "resolved": "https://registry.npmjs.org/eastasianwidth/-/eastasianwidth-0.2.0.tgz",
+      "integrity": "sha512-I88TYZWc9XiYHRQ4/3c5rjjfgkjhLyW2luGIheGERbNQ6OY7yTybanSpDXZa8y7VUP9YmDcYa+eyq4ca7iLqWA==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/ee-first": {
       "version": "1.1.1",
       "resolved": "https://registry.npmjs.org/ee-first/-/ee-first-1.1.1.tgz",
       "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==",
       "license": "MIT"
     },
+    "node_modules/emoji-regex": {
+      "version": "9.2.2",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-9.2.2.tgz",
+      "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/encodeurl": {
       "version": "2.0.0",
       "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
@@ -2258,7 +2474,6 @@
       "deprecated": "This version is no longer supported. Please see https://eslint.org/version-support for other options.",
       "dev": true,
       "license": "MIT",
-      "peer": true,
       "dependencies": {
         "@eslint-community/eslint-utils": "^4.2.0",
         "@eslint-community/regexpp": "^4.6.1",
@@ -2698,6 +2913,23 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/foreground-child": {
+      "version": "3.3.1",
+      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.3.1.tgz",
+      "integrity": "sha512-gIXjKqtFuWEgzFRJA9WCQeSJLZDjgJUOMCMzxtvFq/37KojM1BFGufqsCy0r4qSQmYLsZYMeyRqzIWOMup03sw==",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "cross-spawn": "^7.0.6",
+        "signal-exit": "^4.0.1"
+      },
+      "engines": {
+        "node": ">=14"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/form-data": {
       "version": "4.0.5",
       "resolved": "https://registry.npmjs.org/form-data/-/form-data-4.0.5.tgz",
@@ -2996,6 +3228,13 @@
         "node": ">= 0.4"
       }
     },
+    "node_modules/html-escaper": {
+      "version": "2.0.2",
+      "resolved": "https://registry.npmjs.org/html-escaper/-/html-escaper-2.0.2.tgz",
+      "integrity": "sha512-H2iMtd0I4Mt5eYiapRdIDjp+XzelXQ0tFE4JS7YFwFevXXMmOp9myNrUvCg0D6ws8iqkRPBfKHgbwig1SmlLfg==",
+      "dev": true,
+      "license": "MIT"
+    },
     "node_modules/http-errors": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.1.tgz",
@@ -3128,6 +3367,16 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/is-fullwidth-code-point": {
+      "version": "3.0.0",
+      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
+      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/is-glob": {
       "version": "4.0.3",
       "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
@@ -3168,6 +3417,76 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/istanbul-lib-coverage": {
+      "version": "3.2.2",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-coverage/-/istanbul-lib-coverage-3.2.2.tgz",
+      "integrity": "sha512-O8dpsF+r0WV/8MNRKfnmrtCWhuKjxrq2w+jpzBL5UZKTi2LeVWnWOmWRxFlesJONmc+wLAGvKQZEOanko0LFTg==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/istanbul-lib-report": {
+      "version": "3.0.1",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-report/-/istanbul-lib-report-3.0.1.tgz",
+      "integrity": "sha512-GCfE1mtsHGOELCU8e/Z7YWzpmybrx/+dSTfLrvY8qRmaY6zXTKWn6WQIjaAFw069icm6GVMNkgu0NzI4iPZUNw==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "dependencies": {
+        "istanbul-lib-coverage": "^3.0.0",
+        "make-dir": "^4.0.0",
+        "supports-color": "^7.1.0"
+      },
+      "engines": {
+        "node": ">=10"
+      }
+    },
+    "node_modules/istanbul-lib-source-maps": {
+      "version": "5.0.6",
+      "resolved": "https://registry.npmjs.org/istanbul-lib-source-maps/-/istanbul-lib-source-maps-5.0.6.tgz",
+      "integrity": "sha512-yg2d+Em4KizZC5niWhQaIomgf5WlL4vOOjZ5xGCmF8SnPE/mDWWXgvRExdcpCgh9lLRRa1/fSYp2ymmbJ1pI+A==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "dependencies": {
+        "@jridgewell/trace-mapping": "^0.3.23",
+        "debug": "^4.1.1",
+        "istanbul-lib-coverage": "^3.0.0"
+      },
+      "engines": {
+        "node": ">=10"
+      }
+    },
+    "node_modules/istanbul-reports": {
+      "version": "3.2.0",
+      "resolved": "https://registry.npmjs.org/istanbul-reports/-/istanbul-reports-3.2.0.tgz",
+      "integrity": "sha512-HGYWWS/ehqTV3xN10i23tkPkpH46MLCIMFNCaaKNavAXTF1RkqxawEPtnjnGZ6XKSInBKkiOA5BKS+aZiY3AvA==",
+      "dev": true,
+      "license": "BSD-3-Clause",
+      "dependencies": {
+        "html-escaper": "^2.0.0",
+        "istanbul-lib-report": "^3.0.0"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/jackspeak": {
+      "version": "3.4.3",
+      "resolved": "https://registry.npmjs.org/jackspeak/-/jackspeak-3.4.3.tgz",
+      "integrity": "sha512-OGlZQpz2yfahA/Rd1Y8Cd9SIEsqvXkLVoSw/cgwhnhFMDbsQFeZYoJJ7bIZBS9BcamUW96asq/npPWugM+RQBw==",
+      "dev": true,
+      "license": "BlueOak-1.0.0",
+      "dependencies": {
+        "@isaacs/cliui": "^8.0.2"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      },
+      "optionalDependencies": {
+        "@pkgjs/parseargs": "^0.11.0"
+      }
+    },
     "node_modules/js-yaml": {
       "version": "4.1.1",
       "resolved": "https://registry.npmjs.org/js-yaml/-/js-yaml-4.1.1.tgz",
@@ -3256,6 +3575,13 @@
       "dev": true,
       "license": "MIT"
     },
+    "node_modules/lru-cache": {
+      "version": "10.4.3",
+      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
+      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
+      "dev": true,
+      "license": "ISC"
+    },
     "node_modules/magic-string": {
       "version": "0.30.21",
       "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.21.tgz",
@@ -3266,6 +3592,34 @@
         "@jridgewell/sourcemap-codec": "^1.5.5"
       }
     },
+    "node_modules/magicast": {
+      "version": "0.3.5",
+      "resolved": "https://registry.npmjs.org/magicast/-/magicast-0.3.5.tgz",
+      "integrity": "sha512-L0WhttDl+2BOsybvEOLK7fW3UA0OQ0IQ2d6Zl2x/a6vVRs3bAY0ECOSHHeL5jD+SbOpOCUEi0y1DgHEn9Qn1AQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "@babel/parser": "^7.25.4",
+        "@babel/types": "^7.25.4",
+        "source-map-js": "^1.2.0"
+      }
+    },
+    "node_modules/make-dir": {
+      "version": "4.0.0",
+      "resolved": "https://registry.npmjs.org/make-dir/-/make-dir-4.0.0.tgz",
+      "integrity": "sha512-hXdUTZYIVOt1Ex//jAQi+wTZZpUpwBj/0QsOzqegb3rGMMeJiSEu5xLHnYfBrRV4RH2+OCSOO95Is/7x1WJ4bw==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "semver": "^7.5.3"
+      },
+      "engines": {
+        "node": ">=10"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
     "node_modules/math-intrinsics": {
       "version": "1.1.0",
       "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
@@ -3396,6 +3750,16 @@
         "url": "https://github.com/sponsors/ljharb"
       }
     },
+    "node_modules/minipass": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.1.2.tgz",
+      "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
+      "dev": true,
+      "license": "ISC",
+      "engines": {
+        "node": ">=16 || 14 >=14.17"
+      }
+    },
     "node_modules/mkdirp-classic": {
       "version": "0.5.3",
       "resolved": "https://registry.npmjs.org/mkdirp-classic/-/mkdirp-classic-0.5.3.tgz",
@@ -3544,6 +3908,13 @@
         "url": "https://github.com/sponsors/sindresorhus"
       }
     },
+    "node_modules/package-json-from-dist": {
+      "version": "1.0.1",
+      "resolved": "https://registry.npmjs.org/package-json-from-dist/-/package-json-from-dist-1.0.1.tgz",
+      "integrity": "sha512-UEZIS3/by4OC8vL3P2dTXRETpebLI2NiI5vIrjaD/5UtrkFX/tNbwjTSRAGC/+7CAo2pIcBaRgWmcBBHcsaCIw==",
+      "dev": true,
+      "license": "BlueOak-1.0.0"
+    },
     "node_modules/parent-module": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
@@ -3596,6 +3967,23 @@
         "node": ">=8"
       }
     },
+    "node_modules/path-scurry": {
+      "version": "1.11.1",
+      "resolved": "https://registry.npmjs.org/path-scurry/-/path-scurry-1.11.1.tgz",
+      "integrity": "sha512-Xa4Nw17FS9ApQFJ9umLiJS4orGjm7ZzwUrwamcGQuHSzDyth9boKDaycYdDcZDuqYATXw4HFXgaqWTctW/v1HA==",
+      "dev": true,
+      "license": "BlueOak-1.0.0",
+      "dependencies": {
+        "lru-cache": "^10.2.0",
+        "minipass": "^5.0.0 || ^6.0.2 || ^7.0.0"
+      },
+      "engines": {
+        "node": ">=16 || 14 >=14.18"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/path-to-regexp": {
       "version": "0.1.12",
       "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
@@ -4152,6 +4540,19 @@
       "dev": true,
       "license": "ISC"
     },
+    "node_modules/signal-exit": {
+      "version": "4.1.0",
+      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
+      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
+      "dev": true,
+      "license": "ISC",
+      "engines": {
+        "node": ">=14"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/simple-concat": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/simple-concat/-/simple-concat-1.0.1.tgz",
@@ -4249,6 +4650,76 @@
         "safe-buffer": "~5.2.0"
       }
     },
+    "node_modules/string-width": {
+      "version": "5.1.2",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-5.1.2.tgz",
+      "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "eastasianwidth": "^0.2.0",
+        "emoji-regex": "^9.2.2",
+        "strip-ansi": "^7.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/sindresorhus"
+      }
+    },
+    "node_modules/string-width-cjs": {
+      "name": "string-width",
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/string-width-cjs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/string-width/node_modules/ansi-regex": {
+      "version": "6.2.2",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.2.tgz",
+      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/string-width/node_modules/strip-ansi": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.2.tgz",
+      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
     "node_modules/strip-ansi": {
       "version": "6.0.1",
       "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
@@ -4262,6 +4733,20 @@
         "node": ">=8"
       }
     },
+    "node_modules/strip-ansi-cjs": {
+      "name": "strip-ansi",
+      "version": "6.0.1",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
+      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^5.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
     "node_modules/strip-json-comments": {
       "version": "3.1.1",
       "resolved": "https://registry.npmjs.org/strip-json-comments/-/strip-json-comments-3.1.1.tgz",
@@ -4375,6 +4860,43 @@
         "node": ">=6"
       }
     },
+    "node_modules/test-exclude": {
+      "version": "7.0.1",
+      "resolved": "https://registry.npmjs.org/test-exclude/-/test-exclude-7.0.1.tgz",
+      "integrity": "sha512-pFYqmTw68LXVjeWJMST4+borgQP2AyMNbg1BpZh9LbyhUeNkeaPF9gzfPGUAnSMV3qPYdWUwDIjjCLiSDOl7vg==",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "@istanbuljs/schema": "^0.1.2",
+        "glob": "^10.4.1",
+        "minimatch": "^9.0.4"
+      },
+      "engines": {
+        "node": ">=18"
+      }
+    },
+    "node_modules/test-exclude/node_modules/glob": {
+      "version": "10.5.0",
+      "resolved": "https://registry.npmjs.org/glob/-/glob-10.5.0.tgz",
+      "integrity": "sha512-DfXN8DfhJ7NH3Oe7cFmu3NCu1wKbkReJ8TorzSAFbSKrlNaQSKfIzqYqVY8zlbs2NLBbWpRiU52GX2PbaBVNkg==",
+      "deprecated": "Old versions of glob are not supported, and contain widely publicized security vulnerabilities, which have been fixed in the current version. Please update. Support for old versions may be purchased (at exorbitant rates) by contacting i@izs.me",
+      "dev": true,
+      "license": "ISC",
+      "dependencies": {
+        "foreground-child": "^3.1.0",
+        "jackspeak": "^3.1.2",
+        "minimatch": "^9.0.4",
+        "minipass": "^7.1.2",
+        "package-json-from-dist": "^1.0.0",
+        "path-scurry": "^1.11.1"
+      },
+      "bin": {
+        "glob": "dist/esm/bin.mjs"
+      },
+      "funding": {
+        "url": "https://github.com/sponsors/isaacs"
+      }
+    },
     "node_modules/text-table": {
       "version": "0.2.0",
       "resolved": "https://registry.npmjs.org/text-table/-/text-table-0.2.0.tgz",
@@ -4518,7 +5040,6 @@
       "integrity": "sha512-jl1vZzPDinLr9eUt3J/t7V6FgNEw9QjvBPdysz9KfQDD41fQrC2Y4vKQdiaUpFT4bXlb1RHhLpp8wtm6M5TgSw==",
       "dev": true,
       "license": "Apache-2.0",
-      "peer": true,
       "bin": {
         "tsc": "bin/tsc",
         "tsserver": "bin/tsserver"
@@ -4769,6 +5290,107 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/wrap-ansi": {
+      "version": "8.1.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
+      "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-styles": "^6.1.0",
+        "string-width": "^5.0.1",
+        "strip-ansi": "^7.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi-cjs": {
+      "name": "wrap-ansi",
+      "version": "7.0.0",
+      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
+      "integrity": "sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-styles": "^4.0.0",
+        "string-width": "^4.1.0",
+        "strip-ansi": "^6.0.0"
+      },
+      "engines": {
+        "node": ">=10"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi-cjs/node_modules/emoji-regex": {
+      "version": "8.0.0",
+      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
+      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
+      "dev": true,
+      "license": "MIT"
+    },
+    "node_modules/wrap-ansi-cjs/node_modules/string-width": {
+      "version": "4.2.3",
+      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
+      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "emoji-regex": "^8.0.0",
+        "is-fullwidth-code-point": "^3.0.0",
+        "strip-ansi": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=8"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/ansi-regex": {
+      "version": "6.2.2",
+      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.2.tgz",
+      "integrity": "sha512-Bq3SmSpyFHaWjPk8If9yc6svM8c56dB5BAtW4Qbw5jHTwwXXcTLoRMkpDJp6VL0XzlWaCHTXrkFURMYmD0sLqg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/ansi-styles": {
+      "version": "6.2.3",
+      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.3.tgz",
+      "integrity": "sha512-4Dj6M28JB+oAH8kFkTLUo+a2jwOFkuqb3yucU0CANcRRUbxS0cP0nZYCGjcc3BNXwRIsUVmDGgzawme7zvJHvg==",
+      "dev": true,
+      "license": "MIT",
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
+      }
+    },
+    "node_modules/wrap-ansi/node_modules/strip-ansi": {
+      "version": "7.1.2",
+      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.2.tgz",
+      "integrity": "sha512-gmBGslpoQJtgnMAvOVqGZpEz9dyoKTCzy2nfz/n8aIFhN/jCE/rCmcxabB6jOOHV+0WNnylOxaxBQPSvcWklhA==",
+      "dev": true,
+      "license": "MIT",
+      "dependencies": {
+        "ansi-regex": "^6.0.1"
+      },
+      "engines": {
+        "node": ">=12"
+      },
+      "funding": {
+        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
+      }
+    },
     "node_modules/wrappy": {
       "version": "1.0.2",
       "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
diff --git a/src/collaboration.ts b/src/collaboration.ts
new file mode 100644
index 0000000..6f1bd0e
--- /dev/null
+++ b/src/collaboration.ts
@@ -0,0 +1,262 @@
+import type WebSocket from 'ws';
+import type { DocumentDatabase } from './database.js';
+import type { TextOperation, ServerMessage } from './types.js';
+import { transform, apply, validate } from './ot.js';
+import { randomUUID } from 'crypto';
+
+const WS_OPEN = 1;
+
+interface DocumentSession {
+  documentId: string;
+  version: number;
+  content: string;
+  clients: Map<string, WebSocket>;
+  // Operations log: operationLog[v] is the op that took version v -> version v+1
+  operationLog: TextOperation[];
+}
+
+export class CollaborationManager {
+  private sessions: Map<string, DocumentSession> = new Map();
+  private db: DocumentDatabase;
+
+  constructor(db: DocumentDatabase) {
+    this.db = db;
+  }
+
+  handleConnection(ws: WebSocket, documentId: string): void {
+    const doc = this.db.getDocument(documentId);
+    if (!doc) {
+      this.send(ws, {
+        type: 'error',
+        message: `Document ${documentId} not found`,
+      });
+      ws.close();
+      return;
+    }
+
+    const clientId = randomUUID();
+    const session = this.getOrCreateSession(documentId);
+    session.clients.set(clientId, ws);
+
+    // Send current document state
+    this.send(ws, {
+      type: 'sync',
+      documentId,
+      content: session.content,
+      version: session.version,
+      clientId,
+    });
+
+    ws.on('message', (data) => {
+      try {
+        const message = JSON.parse(data.toString());
+        this.handleMessage(session, clientId, ws, message);
+      } catch (err) {
+        this.send(ws, {
+          type: 'error',
+          message: `Invalid message: ${err instanceof Error ? err.message : 'parse error'}`,
+        });
+      }
+    });
+
+    ws.on('close', () => {
+      session.clients.delete(clientId);
+      if (session.clients.size === 0) {
+        this.sessions.delete(documentId);
+      }
+    });
+
+    ws.on('error', () => {
+      session.clients.delete(clientId);
+      if (session.clients.size === 0) {
+        this.sessions.delete(documentId);
+      }
+    });
+  }
+
+  /** Close all connections for a specific document */
+  closeDocument(documentId: string): void {
+    const session = this.sessions.get(documentId);
+    if (!session) return;
+    for (const client of session.clients.values()) {
+      client.close(1001, 'Document deleted');
+    }
+    this.sessions.delete(documentId);
+  }
+
+  /** Close all connections across all documents */
+  closeAll(): void {
+    for (const session of this.sessions.values()) {
+      for (const client of session.clients.values()) {
+        client.close();
+      }
+    }
+    this.sessions.clear();
+  }
+
+  private getOrCreateSession(documentId: string): DocumentSession {
+    let session = this.sessions.get(documentId);
+    if (session) return session;
+
+    const doc = this.db.getDocument(documentId)!;
+    const version = this.db.getLatestVersion(documentId);
+    const ops = this.db.getOperationsSince(documentId, 0);
+
+    session = {
+      documentId,
+      version,
+      content: doc.content,
+      clients: new Map(),
+      operationLog: ops,
+    };
+    this.sessions.set(documentId, session);
+    return session;
+  }
+
+  private handleMessage(
+    session: DocumentSession,
+    clientId: string,
+    ws: WebSocket,
+    message: unknown
+  ): void {
+    if (!message || typeof message !== 'object') {
+      this.send(ws, { type: 'error', message: 'Invalid message format' });
+      return;
+    }
+
+    const msg = message as Record<string, unknown>;
+
+    if (msg.type !== 'operation') {
+      this.send(ws, {
+        type: 'error',
+        message: `Unknown message type: ${String(msg.type)}`,
+      });
+      return;
+    }
+
+    const version = msg.version;
+    const operation = msg.operation;
+
+    if (typeof version !== 'number' || !Number.isInteger(version) || version < 0) {
+      this.send(ws, { type: 'error', message: 'Invalid version number' });
+      return;
+    }
+
+    if (!Array.isArray(operation)) {
+      this.send(ws, { type: 'error', message: 'Invalid operation format' });
+      return;
+    }
+
+    // Validate individual operation components
+    for (const comp of operation) {
+      if (typeof comp !== 'number' && typeof comp !== 'string') {
+        this.send(ws, { type: 'error', message: 'Invalid operation component type' });
+        return;
+      }
+      if (typeof comp === 'number' && (!Number.isFinite(comp) || !Number.isInteger(comp) || comp === 0)) {
+        this.send(ws, { type: 'error', message: 'Invalid numeric operation component' });
+        return;
+      }
+      if (typeof comp === 'string' && comp.length === 0) {
+        this.send(ws, { type: 'error', message: 'Empty insert string in operation' });
+        return;
+      }
+    }
+
+    this.applyOperation(session, clientId, ws, version, operation as TextOperation);
+  }
+
+  private applyOperation(
+    session: DocumentSession,
+    clientId: string,
+    ws: WebSocket,
+    clientVersion: number,
+    operation: TextOperation
+  ): void {
+    if (clientVersion > session.version) {
+      this.send(ws, {
+        type: 'error',
+        message: `Version ${clientVersion} is ahead of server version ${session.version}`,
+      });
+      return;
+    }
+
+    // Transform against all operations that happened since the client's version
+    let transformedOp = operation;
+
+    for (let v = clientVersion; v < session.version; v++) {
+      const serverOp = session.operationLog[v];
+      if (!serverOp) {
+        this.send(ws, {
+          type: 'error',
+          message: `Missing operation for version ${v + 1}`,
+        });
+        return;
+      }
+      try {
+        [transformedOp] = transform(transformedOp, serverOp);
+      } catch (err) {
+        this.send(ws, {
+          type: 'error',
+          message: `Transform error: ${err instanceof Error ? err.message : 'unknown'}`,
+        });
+        return;
+      }
+    }
+
+    // Validate the transformed operation against the current document
+    const validationError = validate(transformedOp, session.content.length);
+    if (validationError) {
+      this.send(ws, {
+        type: 'error',
+        message: `Invalid operation: ${validationError}`,
+      });
+      return;
+    }
+
+    // Apply the operation to the current document
+    try {
+      const newContent = apply(session.content, transformedOp);
+      session.version += 1;
+      session.content = newContent;
+      session.operationLog.push(transformedOp);
+
+      // Persist to database
+      this.db.addVersion(
+        session.documentId,
+        session.version,
+        newContent,
+        transformedOp
+      );
+
+      // Acknowledge to originating client
+      this.send(ws, {
+        type: 'ack',
+        version: session.version,
+      });
+
+      // Broadcast to all other connected clients
+      for (const [cid, clientWs] of session.clients) {
+        if (cid !== clientId) {
+          this.send(clientWs, {
+            type: 'operation',
+            version: session.version,
+            operation: transformedOp,
+            clientId,
+          });
+        }
+      }
+    } catch (err) {
+      this.send(ws, {
+        type: 'error',
+        message: `Apply error: ${err instanceof Error ? err.message : 'unknown'}`,
+      });
+    }
+  }
+
+  private send(ws: WebSocket, message: ServerMessage): void {
+    if (ws.readyState === WS_OPEN) {
+      ws.send(JSON.stringify(message));
+    }
+  }
+}
diff --git a/src/database.ts b/src/database.ts
new file mode 100644
index 0000000..fd54a42
--- /dev/null
+++ b/src/database.ts
@@ -0,0 +1,130 @@
+import Database from 'better-sqlite3';
+import type { DocumentRecord, VersionRecord, TextOperation } from './types.js';
+
+export class DocumentDatabase {
+  private db: Database.Database;
+
+  constructor(dbPath: string = ':memory:') {
+    this.db = new Database(dbPath);
+    this.db.pragma('journal_mode = WAL');
+    this.db.pragma('foreign_keys = ON');
+    this.initialize();
+  }
+
+  private initialize(): void {
+    this.db.exec(`
+      CREATE TABLE IF NOT EXISTS documents (
+        id TEXT PRIMARY KEY,
+        title TEXT NOT NULL,
+        content TEXT NOT NULL DEFAULT '',
+        created_at TEXT NOT NULL DEFAULT (datetime('now')),
+        updated_at TEXT NOT NULL DEFAULT (datetime('now'))
+      );
+
+      CREATE TABLE IF NOT EXISTS versions (
+        id INTEGER PRIMARY KEY AUTOINCREMENT,
+        document_id TEXT NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
+        version INTEGER NOT NULL,
+        content TEXT NOT NULL,
+        operation TEXT,
+        created_at TEXT NOT NULL DEFAULT (datetime('now')),
+        UNIQUE(document_id, version)
+      );
+    `);
+  }
+
+  createDocument(id: string, title: string, content: string = ''): DocumentRecord {
+    const insertDoc = this.db.prepare(
+      'INSERT INTO documents (id, title, content) VALUES (?, ?, ?)'
+    );
+    insertDoc.run(id, title, content);
+
+    // Create initial version (version 0, no operation)
+    const insertVersion = this.db.prepare(
+      'INSERT INTO versions (document_id, version, content) VALUES (?, 0, ?)'
+    );
+    insertVersion.run(id, content);
+
+    return this.getDocument(id)!;
+  }
+
+  getDocument(id: string): DocumentRecord | undefined {
+    const stmt = this.db.prepare('SELECT * FROM documents WHERE id = ?');
+    return stmt.get(id) as DocumentRecord | undefined;
+  }
+
+  listDocuments(): DocumentRecord[] {
+    const stmt = this.db.prepare('SELECT * FROM documents ORDER BY updated_at DESC');
+    return stmt.all() as DocumentRecord[];
+  }
+
+  updateDocument(
+    id: string,
+    updates: { title?: string; content?: string }
+  ): DocumentRecord | undefined {
+    const doc = this.getDocument(id);
+    if (!doc) return undefined;
+
+    const title = updates.title ?? doc.title;
+    const content = updates.content ?? doc.content;
+
+    const stmt = this.db.prepare(
+      `UPDATE documents SET title = ?, content = ?, updated_at = datetime('now') WHERE id = ?`
+    );
+    stmt.run(title, content, id);
+
+    return this.getDocument(id);
+  }
+
+  deleteDocument(id: string): boolean {
+    const stmt = this.db.prepare('DELETE FROM documents WHERE id = ?');
+    const result = stmt.run(id);
+    return result.changes > 0;
+  }
+
+  getLatestVersion(documentId: string): number {
+    const stmt = this.db.prepare(
+      'SELECT MAX(version) as version FROM versions WHERE document_id = ?'
+    );
+    const result = stmt.get(documentId) as { version: number | null } | undefined;
+    return result?.version ?? 0;
+  }
+
+  addVersion(
+    documentId: string,
+    version: number,
+    content: string,
+    operation: TextOperation
+  ): void {
+    const insertVersion = this.db.prepare(
+      'INSERT INTO versions (document_id, version, content, operation) VALUES (?, ?, ?, ?)'
+    );
+    insertVersion.run(documentId, version, content, JSON.stringify(operation));
+
+    const updateDoc = this.db.prepare(
+      `UPDATE documents SET content = ?, updated_at = datetime('now') WHERE id = ?`
+    );
+    updateDoc.run(content, documentId);
+  }
+
+  getVersions(documentId: string): VersionRecord[] {
+    const stmt = this.db.prepare(
+      'SELECT * FROM versions WHERE document_id = ? ORDER BY version ASC'
+    );
+    return stmt.all(documentId) as VersionRecord[];
+  }
+
+  getOperationsSince(documentId: string, sinceVersion: number): TextOperation[] {
+    const stmt = this.db.prepare(
+      'SELECT operation FROM versions WHERE document_id = ? AND version > ? ORDER BY version ASC'
+    );
+    const rows = stmt.all(documentId, sinceVersion) as { operation: string | null }[];
+    return rows
+      .filter((r): r is { operation: string } => r.operation !== null)
+      .map((r) => JSON.parse(r.operation) as TextOperation);
+  }
+
+  close(): void {
+    this.db.close();
+  }
+}
diff --git a/src/ot.ts b/src/ot.ts
new file mode 100644
index 0000000..a247648
--- /dev/null
+++ b/src/ot.ts
@@ -0,0 +1,212 @@
+import type { TextOperation, OpComponent } from './types.js';
+
+/** Calculate the base length (input document length) of an operation */
+export function baseLength(op: TextOperation): number {
+  let len = 0;
+  for (const comp of op) {
+    if (typeof comp === 'number') {
+      if (comp > 0) len += comp;       // retain
+      else len += Math.abs(comp);       // delete
+    }
+    // inserts don't consume input
+  }
+  return len;
+}
+
+/** Calculate the target length (output document length) of an operation */
+export function targetLength(op: TextOperation): number {
+  let len = 0;
+  for (const comp of op) {
+    if (typeof comp === 'number') {
+      if (comp > 0) len += comp;       // retain produces output
+      // deletes don't produce output
+    } else {
+      len += comp.length;               // insert produces output
+    }
+  }
+  return len;
+}
+
+/** Merge adjacent same-type components and remove no-ops */
+export function normalize(op: TextOperation): TextOperation {
+  const result: TextOperation = [];
+  for (const comp of op) {
+    if (typeof comp === 'number' && comp === 0) continue;
+    if (typeof comp === 'string' && comp === '') continue;
+
+    if (result.length === 0) {
+      result.push(comp);
+      continue;
+    }
+
+    const last = result[result.length - 1];
+    if (typeof comp === 'string' && typeof last === 'string') {
+      result[result.length - 1] = last + comp;
+    } else if (typeof comp === 'number' && typeof last === 'number') {
+      if ((comp > 0 && last > 0) || (comp < 0 && last < 0)) {
+        result[result.length - 1] = (last as number) + (comp as number);
+      } else {
+        result.push(comp);
+      }
+    } else {
+      result.push(comp);
+    }
+  }
+  return result;
+}
+
+/** Apply an operation to a document string, returning the new document */
+export function apply(doc: string, op: TextOperation): string {
+  const bLen = baseLength(op);
+  if (bLen !== doc.length) {
+    throw new Error(
+      `Operation base length (${bLen}) doesn't match document length (${doc.length})`
+    );
+  }
+
+  let result = '';
+  let pos = 0;
+
+  for (const comp of op) {
+    if (typeof comp === 'string') {
+      result += comp;
+    } else if (comp > 0) {
+      result += doc.slice(pos, pos + comp);
+      pos += comp;
+    } else {
+      pos += Math.abs(comp);
+    }
+  }
+
+  return result;
+}
+
+/**
+ * Transform two concurrent operations that were both based on the same document.
+ * Returns [op1', op2'] such that:
+ *   apply(apply(doc, op1), op2') === apply(apply(doc, op2), op1')
+ *
+ * op1's inserts take priority (appear before op2's inserts at the same position).
+ */
+export function transform(
+  op1: TextOperation,
+  op2: TextOperation
+): [TextOperation, TextOperation] {
+  if (baseLength(op1) !== baseLength(op2)) {
+    throw new Error(
+      `Operations must have the same base length for transform: ${baseLength(op1)} vs ${baseLength(op2)}`
+    );
+  }
+
+  const result1: OpComponent[] = [];
+  const result2: OpComponent[] = [];
+
+  let i1 = 0;
+  let i2 = 0;
+  let rem1: OpComponent | null = null;
+  let rem2: OpComponent | null = null;
+
+  function next1(): OpComponent | undefined {
+    if (rem1 !== null) {
+      const v = rem1;
+      rem1 = null;
+      return v;
+    }
+    if (i1 < op1.length) return op1[i1++];
+    return undefined;
+  }
+
+  function next2(): OpComponent | undefined {
+    if (rem2 !== null) {
+      const v = rem2;
+      rem2 = null;
+      return v;
+    }
+    if (i2 < op2.length) return op2[i2++];
+    return undefined;
+  }
+
+  while (true) {
+    const c1 = next1();
+    const c2 = next2();
+
+    if (c1 === undefined && c2 === undefined) break;
+
+    // Insert in op1 takes priority - doesn't consume base doc chars
+    if (typeof c1 === 'string') {
+      result1.push(c1);
+      result2.push(c1.length); // result2 retains past op1's insert
+      if (c2 !== undefined) rem2 = c2;
+      continue;
+    }
+
+    // Insert in op2
+    if (typeof c2 === 'string') {
+      result1.push(c2.length); // result1 retains past op2's insert
+      result2.push(c2);
+      if (c1 !== undefined) rem1 = c1;
+      continue;
+    }
+
+    if (c1 === undefined || c2 === undefined) {
+      throw new Error('Transform: mismatched operation lengths');
+    }
+
+    // Both are numbers (retain or delete)
+    const n1 = c1 as number;
+    const n2 = c2 as number;
+
+    if (n1 > 0 && n2 > 0) {
+      // Both retain
+      const min = Math.min(n1, n2);
+      result1.push(min);
+      result2.push(min);
+      if (n1 > min) rem1 = n1 - min;
+      if (n2 > min) rem2 = n2 - min;
+    } else if (n1 < 0 && n2 < 0) {
+      // Both delete the same region - neither result needs to act
+      const min = Math.min(Math.abs(n1), Math.abs(n2));
+      if (Math.abs(n1) > min) rem1 = -(Math.abs(n1) - min);
+      if (Math.abs(n2) > min) rem2 = -(Math.abs(n2) - min);
+    } else if (n1 > 0 && n2 < 0) {
+      // op1 retains, op2 deletes
+      // After op2: chars are gone, so op1' skips them
+      // After op1: chars still there, so op2' still deletes
+      const min = Math.min(n1, Math.abs(n2));
+      result2.push(-min);
+      if (n1 > min) rem1 = n1 - min;
+      if (Math.abs(n2) > min) rem2 = -(Math.abs(n2) - min);
+    } else if (n1 < 0 && n2 > 0) {
+      // op1 deletes, op2 retains
+      const min = Math.min(Math.abs(n1), n2);
+      result1.push(-min);
+      if (Math.abs(n1) > min) rem1 = -(Math.abs(n1) - min);
+      if (n2 > min) rem2 = n2 - min;
+    }
+  }
+
+  return [normalize(result1), normalize(result2)];
+}
+
+/** Validate that an operation is well-formed for a document of given length */
+export function validate(op: TextOperation, docLength: number): string | null {
+  for (let i = 0; i < op.length; i++) {
+    const comp = op[i];
+    if (typeof comp === 'string') {
+      if (comp.length === 0) return `Empty insert string at index ${i}`;
+    } else if (typeof comp === 'number') {
+      if (!Number.isFinite(comp)) return `Non-finite number at index ${i}`;
+      if (!Number.isInteger(comp)) return `Non-integer component at index ${i}`;
+      if (comp === 0) return `Zero-length component at index ${i}`;
+    } else {
+      return `Invalid component type at index ${i}: ${typeof comp}`;
+    }
+  }
+
+  const bLen = baseLength(op);
+  if (bLen !== docLength) {
+    return `Operation base length (${bLen}) doesn't match document length (${docLength})`;
+  }
+
+  return null;
+}
diff --git a/src/routes.ts b/src/routes.ts
new file mode 100644
index 0000000..39fba87
--- /dev/null
+++ b/src/routes.ts
@@ -0,0 +1,76 @@
+import { Router } from 'express';
+import { randomUUID } from 'crypto';
+import type { DocumentDatabase } from './database.js';
+import type { CollaborationManager } from './collaboration.js';
+
+export function createRouter(
+  db: DocumentDatabase,
+  collaboration: CollaborationManager
+): Router {
+  const router = Router();
+
+  // Create document
+  router.post('/documents', (req, res) => {
+    const { title, content } = req.body;
+
+    if (!title || typeof title !== 'string') {
+      res.status(400).json({ error: 'Title is required and must be a string' });
+      return;
+    }
+
+    const id = randomUUID();
+    const doc = db.createDocument(id, title, typeof content === 'string' ? content : '');
+    res.status(201).json(doc);
+  });
+
+  // List documents
+  router.get('/documents', (_req, res) => {
+    const docs = db.listDocuments();
+    res.json(docs);
+  });
+
+  // Get document
+  router.get('/documents/:id', (req, res) => {
+    const doc = db.getDocument(req.params.id);
+    if (!doc) {
+      res.status(404).json({ error: 'Document not found' });
+      return;
+    }
+    res.json(doc);
+  });
+
+  // Update document
+  router.put('/documents/:id', (req, res) => {
+    const { title, content } = req.body;
+    const doc = db.updateDocument(req.params.id, { title, content });
+    if (!doc) {
+      res.status(404).json({ error: 'Document not found' });
+      return;
+    }
+    res.json(doc);
+  });
+
+  // Delete document
+  router.delete('/documents/:id', (req, res) => {
+    collaboration.closeDocument(req.params.id);
+    const deleted = db.deleteDocument(req.params.id);
+    if (!deleted) {
+      res.status(404).json({ error: 'Document not found' });
+      return;
+    }
+    res.status(204).send();
+  });
+
+  // Get version history
+  router.get('/documents/:id/versions', (req, res) => {
+    const doc = db.getDocument(req.params.id);
+    if (!doc) {
+      res.status(404).json({ error: 'Document not found' });
+      return;
+    }
+    const versions = db.getVersions(req.params.id);
+    res.json(versions);
+  });
+
+  return router;
+}
diff --git a/src/server.ts b/src/server.ts
new file mode 100644
index 0000000..edfa370
--- /dev/null
+++ b/src/server.ts
@@ -0,0 +1,98 @@
+import express from 'express';
+import http from 'http';
+import { WebSocketServer } from 'ws';
+import type WebSocket from 'ws';
+import { DocumentDatabase } from './database.js';
+import { createRouter } from './routes.js';
+import { CollaborationManager } from './collaboration.js';
+import type { Socket } from 'net';
+
+export interface AppInstance {
+  app: express.Express;
+  start: (port?: number) => Promise<number>;
+  stop: () => Promise<void>;
+}
+
+export function createApp(dbPath?: string): AppInstance {
+  const db = new DocumentDatabase(dbPath || ':memory:');
+  const collaboration = new CollaborationManager(db);
+
+  const app = express();
+  app.use(express.json());
+  app.use(createRouter(db, collaboration));
+
+  const server = http.createServer(app);
+  const wss = new WebSocketServer({ noServer: true });
+
+  // Track TCP sockets for clean shutdown
+  const sockets = new Set<Socket>();
+  server.on('connection', (socket: Socket) => {
+    sockets.add(socket);
+    socket.once('close', () => sockets.delete(socket));
+  });
+
+  // Handle WebSocket upgrades: /ws/:documentId
+  server.on('upgrade', (request, socket, head) => {
+    const url = new URL(request.url || '', `http://${request.headers.host || 'localhost'}`);
+    const match = url.pathname.match(/^\/ws\/(.+)$/);
+
+    if (!match) {
+      socket.destroy();
+      return;
+    }
+
+    let documentId: string;
+    try {
+      documentId = decodeURIComponent(match[1]);
+    } catch {
+      socket.destroy();
+      return;
+    }
+
+    wss.handleUpgrade(request, socket, head, (ws: WebSocket) => {
+      collaboration.handleConnection(ws, documentId);
+    });
+  });
+
+  let listening = false;
+
+  return {
+    app,
+    start: (port?: number): Promise<number> => {
+      return new Promise((resolve, reject) => {
+        server.once('error', reject);
+        server.listen(port || 0, () => {
+          listening = true;
+          const addr = server.address();
+          if (addr && typeof addr === 'object') {
+            resolve(addr.port);
+          } else {
+            reject(new Error('Failed to get server address'));
+          }
+        });
+      });
+    },
+    stop: (): Promise<void> => {
+      return new Promise((resolve) => {
+        collaboration.closeAll();
+        wss.close();
+
+        // Destroy all TCP connections for immediate shutdown
+        for (const socket of sockets) {
+          socket.destroy();
+        }
+        sockets.clear();
+
+        if (listening) {
+          server.close(() => {
+            db.close();
+            resolve();
+          });
+        } else {
+          db.close();
+          resolve();
+        }
+      });
+    },
+  };
+}
diff --git a/src/types.ts b/src/types.ts
new file mode 100644
index 0000000..76f75f4
--- /dev/null
+++ b/src/types.ts
@@ -0,0 +1,62 @@
+// OT operation components:
+// - positive number = retain N characters
+// - string = insert that string
+// - negative number = delete N characters (absolute value)
+export type OpComponent = number | string;
+export type TextOperation = OpComponent[];
+
+export interface DocumentRecord {
+  id: string;
+  title: string;
+  content: string;
+  created_at: string;
+  updated_at: string;
+}
+
+export interface VersionRecord {
+  id: number;
+  document_id: string;
+  version: number;
+  content: string;
+  operation: string | null;
+  created_at: string;
+}
+
+// WebSocket messages: client -> server
+export interface ClientOperationMessage {
+  type: 'operation';
+  version: number;
+  operation: TextOperation;
+}
+
+// WebSocket messages: server -> client
+export interface ServerSyncMessage {
+  type: 'sync';
+  documentId: string;
+  content: string;
+  version: number;
+  clientId: string;
+}
+
+export interface ServerAckMessage {
+  type: 'ack';
+  version: number;
+}
+
+export interface ServerOperationMessage {
+  type: 'operation';
+  version: number;
+  operation: TextOperation;
+  clientId: string;
+}
+
+export interface ServerErrorMessage {
+  type: 'error';
+  message: string;
+}
+
+export type ServerMessage =
+  | ServerSyncMessage
+  | ServerAckMessage
+  | ServerOperationMessage
+  | ServerErrorMessage;
